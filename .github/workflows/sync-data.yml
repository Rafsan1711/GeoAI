name: Sync Data Files (frontend ↔ backend)

# ─────────────────────────────────────────────────────────────────────────────
# LOGIC:
#   - frontend/data/* changed  →  copy to backend/data/   (same filename)
#   - backend/data/*  changed  →  copy to frontend/data/  (same filename)
#   - Both changed in same commit → both directions handled, no double-loop
#   - Commits made by github-actions[bot] are IGNORED to prevent infinite loop
# ─────────────────────────────────────────────────────────────────────────────

on:
  push:
    branches: [main]
    paths:
      - "frontend/data/**"
      - "backend/data/**"

jobs:
  sync-data:
    runs-on: ubuntu-latest

    # ── CRITICAL: Skip commits made by this bot itself (infinite loop guard) ──
    if: github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2          # Need 2 commits to diff properly
          token: ${{ secrets.GITHUB_TOKEN }}

      # ── Step 1: Detect exactly which data files changed in this push ─────────
      - name: Detect changed data files
        id: detect
        run: |
          echo "=== Detecting changed files in data folders ==="

          # Get list of changed files between previous commit and current HEAD
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD 2>/dev/null)
          echo "All changed files:"
          echo "$CHANGED"

          # Filter: files inside frontend/data/ or backend/data/
          FRONTEND_CHANGED=$(echo "$CHANGED" | grep '^frontend/data/' | grep -v '^$' || true)
          BACKEND_CHANGED=$(echo "$CHANGED"  | grep '^backend/data/'  | grep -v '^$' || true)

          echo ""
          echo "frontend/data/ changed: [$FRONTEND_CHANGED]"
          echo "backend/data/  changed: [$BACKEND_CHANGED]"

          # Write to step outputs (multiline safe)
          {
            echo "frontend_changed<<EOF"
            echo "$FRONTEND_CHANGED"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          {
            echo "backend_changed<<EOF"
            echo "$BACKEND_CHANGED"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          # Did anything change at all?
          if [ -z "$FRONTEND_CHANGED" ] && [ -z "$BACKEND_CHANGED" ]; then
            echo "nothing_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "nothing_changed=false" >> "$GITHUB_OUTPUT"
          fi

      # ── Step 2: Early exit if nothing relevant changed ────────────────────────
      - name: Early exit check
        if: steps.detect.outputs.nothing_changed == 'true'
        run: |
          echo "No changes in frontend/data/ or backend/data/ — nothing to sync."
          exit 0

      # ── Step 3: Sync frontend/data/* → backend/data/ ─────────────────────────
      - name: Sync frontend → backend
        if: steps.detect.outputs.frontend_changed != ''
        run: |
          echo "=== Syncing frontend/data/ → backend/data/ ==="

          # Ensure destination exists
          mkdir -p backend/data

          SYNCED=0
          SKIPPED=0

          while IFS= read -r filepath; do
            [ -z "$filepath" ] && continue

            # Extract just the filename (e.g. "countries.json")
            filename=$(basename "$filepath")

            src="frontend/data/$filename"
            dst="backend/data/$filename"

            if [ ! -f "$src" ]; then
              echo "  SKIP: $src does not exist (deleted file?)"
              SKIPPED=$((SKIPPED + 1))
              continue
            fi

            # Check if destination already has identical content (avoid noise)
            if [ -f "$dst" ] && cmp -s "$src" "$dst"; then
              echo "  IDENTICAL: $filename — no sync needed"
              SKIPPED=$((SKIPPED + 1))
              continue
            fi

            cp "$src" "$dst"
            echo "  SYNCED: $filename  (frontend/data → backend/data)"
            SYNCED=$((SYNCED + 1))

          done <<< "${{ steps.detect.outputs.frontend_changed }}"

          echo ""
          echo "frontend→backend: $SYNCED synced, $SKIPPED skipped"

      # ── Step 4: Sync backend/data/* → frontend/data/ ─────────────────────────
      - name: Sync backend → frontend
        if: steps.detect.outputs.backend_changed != ''
        run: |
          echo "=== Syncing backend/data/ → frontend/data/ ==="

          # Ensure destination exists
          mkdir -p frontend/data

          SYNCED=0
          SKIPPED=0

          while IFS= read -r filepath; do
            [ -z "$filepath" ] && continue

            filename=$(basename "$filepath")

            src="backend/data/$filename"
            dst="frontend/data/$filename"

            if [ ! -f "$src" ]; then
              echo "  SKIP: $src does not exist (deleted file?)"
              SKIPPED=$((SKIPPED + 1))
              continue
            fi

            if [ -f "$dst" ] && cmp -s "$src" "$dst"; then
              echo "  IDENTICAL: $filename — no sync needed"
              SKIPPED=$((SKIPPED + 1))
              continue
            fi

            cp "$src" "$dst"
            echo "  SYNCED: $filename  (backend/data → frontend/data)"
            SYNCED=$((SYNCED + 1))

          done <<< "${{ steps.detect.outputs.backend_changed }}"

          echo ""
          echo "backend→frontend: $SYNCED synced, $SKIPPED skipped"

      # ── Step 5: Check if any actual file changes were made ────────────────────
      - name: Check for actual changes to commit
        id: git_status
        run: |
          git add frontend/data/ backend/data/

          if git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "Nothing to commit — files were already in sync."
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Changes staged and ready to commit:"
            git diff --cached --name-only
          fi

      # ── Step 6: Commit and push synced files ─────────────────────────────────
      - name: Commit synced files
        if: steps.git_status.outputs.has_changes == 'true'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Build a descriptive commit message listing what was synced
          FRONTEND_LIST="${{ steps.detect.outputs.frontend_changed }}"
          BACKEND_LIST="${{ steps.detect.outputs.backend_changed }}"

          MSG_PARTS=()

          if [ -n "$FRONTEND_LIST" ]; then
            FILES=$(echo "$FRONTEND_LIST" | xargs -I{} basename {} | tr '\n' ',' | sed 's/,$//')
            MSG_PARTS+=("frontend→backend: $FILES")
          fi

          if [ -n "$BACKEND_LIST" ]; then
            FILES=$(echo "$BACKEND_LIST" | xargs -I{} basename {} | tr '\n' ',' | sed 's/,$//')
            MSG_PARTS+=("backend→frontend: $FILES")
          fi

          # Join parts
          COMMIT_MSG=$(IFS=' | '; echo "sync: data ${MSG_PARTS[*]} [skip ci]")

          git commit -m "$COMMIT_MSG"
          git push

          echo "✅ Sync commit pushed successfully."

      # ── Step 7: Summary ───────────────────────────────────────────────────────
      - name: Print summary
        if: always()
        run: |
          echo "════════════════════════════════════"
          echo "  GeoAI Data Sync — Job Complete"
          echo "════════════════════════════════════"
          echo "  Actor       : ${{ github.actor }}"
          echo "  Commit SHA  : ${{ github.sha }}"
          echo "  Has changes : ${{ steps.git_status.outputs.has_changes }}"
          echo "════════════════════════════════════"
