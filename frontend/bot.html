<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GeoAI Bot Runner v2.1</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --bg-0:#070711;--bg-1:#0d0d1a;--bg-2:#12121f;--bg-3:#1a1a2e;--bg-4:#20203a;
  --indigo:#6366f1;--purple:#a855f7;--cyan:#06b6d4;
  --emerald:#10b981;--rose:#f43f5e;--amber:#f59e0b;--sky:#38bdf8;
  --text-1:#f1f5f9;--text-2:#94a3b8;--text-3:#475569;
  --radius:12px;--radius-sm:8px;--radius-lg:16px;
  --tr:all .2s ease;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:var(--bg-0);color:var(--text-1);min-height:100vh;overflow-x:hidden}
a{color:inherit;text-decoration:none}
button{cursor:pointer;font-family:'Inter',sans-serif}

/* BG */
.bg-orbs{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.orb{position:absolute;border-radius:50%;filter:blur(80px);opacity:.12}
.orb-1{width:600px;height:600px;background:radial-gradient(circle,var(--indigo),transparent);top:-200px;left:-200px;animation:d1 18s ease-in-out infinite alternate}
.orb-2{width:500px;height:500px;background:radial-gradient(circle,var(--purple),transparent);bottom:-150px;right:-150px;animation:d2 22s ease-in-out infinite alternate}
.orb-3{width:400px;height:400px;background:radial-gradient(circle,var(--cyan),transparent);top:40%;left:50%;transform:translate(-50%,-50%);animation:d3 15s ease-in-out infinite alternate}
@keyframes d1{to{transform:translate(60px,40px)}}
@keyframes d2{to{transform:translate(-40px,-60px)}}
@keyframes d3{to{transform:translate(30px,-30px)}}

/* LAYOUT */
#app{position:relative;z-index:1}
.wrap{max-width:1100px;margin:0 auto;padding:24px 20px 100px}

/* NAVBAR */
.navbar{position:sticky;top:0;z-index:100;display:flex;align-items:center;gap:8px;padding:0 20px;height:58px;background:rgba(7,7,17,.88);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06)}
.nav-logo{display:flex;align-items:center;gap:10px;font-weight:800;font-size:17px}
.nav-logo-icon{font-size:22px}
.nav-badge{background:rgba(99,102,241,.2);border:1px solid rgba(99,102,241,.35);color:var(--indigo);font-size:10px;font-weight:700;padding:2px 8px;border-radius:99px;letter-spacing:.5px;text-transform:uppercase}
.nav-sp{flex:1}
.nav-btn{display:flex;align-items:center;gap:6px;padding:7px 13px;border-radius:var(--radius-sm);background:transparent;border:1px solid rgba(255,255,255,.08);color:var(--text-2);font-size:13px;font-weight:600;transition:var(--tr)}
.nav-btn:hover{background:rgba(255,255,255,.06);color:var(--text-1)}
.nav-btn.active{background:rgba(99,102,241,.15);border-color:rgba(99,102,241,.4);color:var(--indigo)}

/* SETTINGS */
.s-overlay{position:fixed;inset:0;z-index:150;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:opacity .25s}
.s-overlay.open{opacity:1;pointer-events:all}
.s-panel{position:fixed;top:66px;left:50%;transform:translateX(-50%) translateY(-16px);z-index:160;width:min(680px,calc(100vw - 32px));background:var(--bg-2);border:1px solid rgba(99,102,241,.2);border-radius:var(--radius-lg);box-shadow:0 40px 100px rgba(0,0,0,.8);padding:28px;opacity:0;pointer-events:none;transition:opacity .3s,transform .3s}
.s-panel.open{opacity:1;pointer-events:all;transform:translateX(-50%) translateY(0)}
.s-title{display:flex;align-items:center;gap:10px;font-size:16px;font-weight:800;margin-bottom:22px}
.s-title i{color:var(--indigo)}
.s-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:520px){.s-grid{grid-template-columns:1fr}}
.s-field{display:flex;flex-direction:column;gap:5px}
.s-field.full{grid-column:1/-1}
.s-field label{font-size:11px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:.6px;display:flex;align-items:center;gap:5px}
.s-field label i{color:var(--indigo);font-size:10px}
.s-input{background:var(--bg-3);border:1px solid rgba(255,255,255,.07);border-radius:var(--radius-sm);color:var(--text-1);font-family:'JetBrains Mono',monospace;font-size:13px;padding:9px 13px;outline:none;transition:border-color .2s;width:100%}
.s-input:focus{border-color:var(--indigo)}
.s-input::placeholder{color:var(--text-3)}
input[type="password"].s-input{letter-spacing:3px}
input[type="password"].s-input:focus{letter-spacing:normal}
.s-hint{font-size:11px;color:var(--text-3);margin-top:2px;display:flex;align-items:center;gap:4px}
.s-hint i{color:var(--amber)}
.s-row{display:flex;align-items:center;gap:10px;margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,.06)}
.s-conc-label{font-size:13px;color:var(--text-2);font-weight:600;flex:1}
.s-conc-ctrl{display:flex;align-items:center;gap:10px}
.s-conc-ctrl button{width:28px;height:28px;border-radius:var(--radius-sm);background:var(--bg-3);border:1px solid rgba(255,255,255,.1);color:var(--text-1);font-size:15px;font-weight:700;display:flex;align-items:center;justify-content:center;transition:var(--tr)}
.s-conc-ctrl button:hover{border-color:var(--indigo);background:var(--bg-4)}
.s-conc-val{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:700;color:var(--indigo);min-width:28px;text-align:center}
.s-actions{display:flex;gap:10px;margin-top:18px;justify-content:flex-end}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border-radius:var(--radius-sm);border:none;font-family:'Inter',sans-serif;font-size:14px;font-weight:700;transition:var(--tr);white-space:nowrap}
.btn i{font-size:13px}
.btn-primary{background:linear-gradient(135deg,var(--indigo),var(--purple));color:#fff;box-shadow:0 4px 20px rgba(99,102,241,.3)}
.btn-primary:hover{filter:brightness(1.1);transform:translateY(-1px)}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.1);color:var(--text-2)}
.btn-ghost:hover{background:rgba(255,255,255,.06);color:var(--text-1)}
.btn-danger{background:rgba(244,63,94,.1);border:1px solid rgba(244,63,94,.3);color:var(--rose)}
.btn-danger:hover{background:rgba(244,63,94,.2)}
.btn-sm{padding:7px 13px;font-size:13px}
.btn:disabled{opacity:.4;pointer-events:none}
@keyframes pulse-ring{0%,100%{box-shadow:0 4px 20px rgba(99,102,241,.3)}50%{box-shadow:0 4px 32px rgba(99,102,241,.7),0 0 0 8px rgba(99,102,241,.1)}}
.btn-running{animation:pulse-ring 1.5s ease-in-out infinite}

/* HERO */
.hero{padding:56px 20px 36px;text-align:center}
.hero-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(99,102,241,.1);border:1px solid rgba(99,102,241,.25);color:var(--indigo);padding:5px 15px;border-radius:99px;font-size:13px;font-weight:700;margin-bottom:18px}
.hero-title{font-size:clamp(26px,5vw,50px);font-weight:900;line-height:1.1;letter-spacing:-1.5px;margin-bottom:12px;background:linear-gradient(135deg,#fff 0%,var(--indigo) 50%,var(--cyan) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hero-sub{font-size:15px;color:var(--text-2);line-height:1.7;max-width:540px;margin:0 auto 22px}
.cfg-status{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-bottom:22px}
.cfg-pill{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:99px;font-size:12px;font-weight:700;border:1px solid transparent;transition:var(--tr)}
.cfg-pill.ok{background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.25);color:var(--emerald)}
.cfg-pill.warn{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.25);color:var(--amber)}
.cfg-pill.error{background:rgba(244,63,94,.1);border-color:rgba(244,63,94,.25);color:var(--rose)}
.run-ctrls{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-bottom:28px}

/* LIVE TIMER */
.live-bar{display:none;justify-content:center;align-items:center;gap:10px;margin-bottom:16px;font-family:'JetBrains Mono',monospace}
.live-bar.on{display:flex}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--emerald);animation:blink 1s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
.live-txt{font-size:13px;color:var(--text-2)}
.live-txt span{color:var(--emerald);font-weight:700}

/* STATS */
.stats-bar{display:grid;grid-template-columns:repeat(6,1fr);background:var(--bg-1);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);overflow:hidden;margin-bottom:28px}
@media(max-width:640px){.stats-bar{grid-template-columns:repeat(3,1fr)}}
.stat-item{padding:14px 8px;text-align:center;border-right:1px solid rgba(255,255,255,.05)}
.stat-item:last-child{border-right:none}
.sv{font-size:20px;font-weight:800;line-height:1;margin-bottom:3px;font-variant-numeric:tabular-nums;transition:color .3s}
.sv.blue{color:var(--sky)}.sv.purple{color:var(--purple)}.sv.green{color:var(--emerald)}.sv.red{color:var(--rose)}.sv.amber{color:var(--amber)}.sv.cyan{color:var(--cyan)}
.sl{font-size:10px;color:var(--text-3);font-weight:700;text-transform:uppercase;letter-spacing:.5px}

/* PROGRESS */
.prog-wrap{margin-bottom:24px}
.prog-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.prog-lbl{font-size:13px;font-weight:700;color:var(--text-2);display:flex;align-items:center;gap:6px}
.prog-lbl i{color:var(--indigo)}
.prog-meta{font-size:12px;color:var(--text-3);font-family:'JetBrains Mono',monospace}
.prog-track{height:7px;background:var(--bg-3);border-radius:99px;overflow:hidden}
.prog-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--indigo),var(--purple),var(--cyan));background-size:200% 100%;transition:width .5s ease;animation:shimmer 2.5s linear infinite}
@keyframes shimmer{0%{background-position:200% center}100%{background-position:-200% center}}

/* CONTINENT */
.cont-sec{margin-bottom:10px;border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);overflow:hidden;background:var(--bg-1)}
.cont-hdr{display:flex;align-items:center;gap:10px;padding:12px 16px;cursor:pointer;user-select:none;background:var(--bg-2);transition:background .2s}
.cont-hdr:hover{background:var(--bg-3)}
.cont-emoji{font-size:18px}
.cont-name{font-weight:800;font-size:14px}
.cont-acc{font-size:11px;padding:2px 9px;border-radius:99px;font-weight:700;background:rgba(99,102,241,.1);color:var(--indigo)}
.cont-acc.good{background:rgba(16,185,129,.1);color:var(--emerald)}
.cont-acc.bad{background:rgba(244,63,94,.1);color:var(--rose)}
.cont-pw{flex:1;background:var(--bg-3);height:4px;border-radius:99px;overflow:hidden;margin:0 8px}
.cont-pf{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--emerald),var(--cyan));transition:width .5s ease}
.cont-cnt{font-size:11px;color:var(--text-3);font-family:'JetBrains Mono',monospace;white-space:nowrap}
.cont-chev{color:var(--text-3);font-size:11px;transition:transform .25s}
.cont-sec.open .cont-chev{transform:rotate(180deg)}
.cont-body{display:none;padding:10px;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:7px}
.cont-sec.open .cont-body{display:grid}

/* COUNTRY CARDS */
.c-card{display:flex;align-items:center;gap:10px;padding:9px 11px;border-radius:var(--radius-sm);background:var(--bg-2);border:1px solid rgba(255,255,255,.05);cursor:pointer;transition:border-color .2s,background .2s,transform .15s}
.c-card:hover{border-color:rgba(99,102,241,.35);background:var(--bg-3);transform:translateY(-1px)}
.c-card.s-pending{border-color:rgba(255,255,255,.05)}
.c-card.s-running{border-color:var(--indigo);background:rgba(99,102,241,.08);animation:cpulse .9s ease-in-out infinite alternate}
.c-card.s-correct{border-color:rgba(16,185,129,.3);background:rgba(16,185,129,.05)}
.c-card.s-wrong{border-color:rgba(244,63,94,.3);background:rgba(244,63,94,.05)}
@keyframes cpulse{from{box-shadow:none}to{box-shadow:0 0 10px rgba(99,102,241,.25)}}
.c-flag{font-size:20px;flex-shrink:0;line-height:1}
.c-info{flex:1;min-width:0}
.c-name{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.c-meta{font-size:11px;color:var(--text-3);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.c-qb{font-size:10px;font-family:'JetBrains Mono',monospace;font-weight:600;padding:2px 5px;border-radius:4px;background:var(--bg-3);color:var(--text-3);white-space:nowrap;display:none}
.c-ico{font-size:14px;flex-shrink:0}
.c-ico.s-pending{color:var(--text-3)}.c-ico.s-running{color:var(--indigo);animation:spin .7s linear infinite}.c-ico.s-correct{color:var(--emerald)}.c-ico.s-wrong{color:var(--rose)}
@keyframes spin{to{transform:rotate(360deg)}}

/* DRAWER */
.drw-ov{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity .3s}
.drw-ov.open{opacity:1;pointer-events:all}
.drw{position:fixed;bottom:0;left:0;right:0;z-index:210;background:var(--bg-1);border-top:1px solid rgba(255,255,255,.08);border-radius:var(--radius-lg) var(--radius-lg) 0 0;max-height:82vh;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .35s cubic-bezier(.4,0,.2,1)}
.drw.open{transform:translateY(0)}
.drw-handle{padding:12px;display:flex;justify-content:center;flex-shrink:0}
.drw-handle-bar{width:40px;height:4px;background:var(--bg-4);border-radius:99px}
.drw-hdr{display:flex;align-items:center;gap:14px;padding:0 20px 14px;flex-shrink:0}
.drw-flag{font-size:34px}
.drw-cname{font-size:17px;font-weight:800}
.drw-csub{font-size:12px;color:var(--text-3);margin-top:2px}
.drw-close{margin-left:auto;width:30px;height:30px;border-radius:50%;background:var(--bg-3);border:1px solid rgba(255,255,255,.08);color:var(--text-2);display:flex;align-items:center;justify-content:center;transition:var(--tr)}
.drw-close:hover{background:var(--bg-4);color:var(--text-1)}
.drw-banner{display:flex;align-items:center;gap:10px;padding:11px 20px;font-size:13px;font-weight:700;flex-shrink:0}
.drw-banner.pending{background:rgba(99,102,241,.08);color:var(--indigo)}
.drw-banner.correct{background:rgba(16,185,129,.1);color:var(--emerald)}
.drw-banner.wrong{background:rgba(244,63,94,.1);color:var(--rose)}
.drw-body{flex:1;overflow-y:auto;padding:0 20px 10px}
.drw-md{font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.8;color:var(--text-2);white-space:pre-wrap;word-break:break-word}
.drw-ph{display:flex;flex-direction:column;align-items:center;gap:12px;padding:40px;color:var(--text-3);text-align:center}
.drw-ph i{font-size:38px;opacity:.25}
.drw-ph p{font-size:13px}
.drw-acts{display:flex;gap:10px;padding:14px 20px;border-top:1px solid rgba(255,255,255,.06);flex-shrink:0}

/* SECTION HEADER */
.sec-hdr{display:flex;align-items:center;gap:10px;margin-bottom:14px;margin-top:32px}
.sec-hdr-title{font-size:14px;font-weight:800;display:flex;align-items:center;gap:8px}
.sec-hdr-title i{color:var(--indigo)}
.sec-sp{flex:1}

/* REPORT */
.report-box{background:var(--bg-1);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);overflow:hidden;max-height:0;transition:max-height .4s ease}
.report-box.open{max-height:700px;overflow-y:auto}
.report-pre{font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.8;color:var(--text-2);white-space:pre-wrap;word-break:break-word;padding:20px}

/* LOG */
.log-box{background:#06060f;border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--text-2);height:200px;overflow-y:auto;padding:12px 14px}
.log-line{display:flex;gap:8px;margin-bottom:2px}
.log-ts{color:var(--text-3);flex-shrink:0}
.log-ok{color:var(--emerald)}.log-err{color:var(--rose)}.log-warn{color:var(--amber)}.log-info{color:var(--sky)}

/* TOAST */
#toasts{position:fixed;bottom:24px;right:20px;z-index:999;display:flex;flex-direction:column;gap:8px}
.toast{padding:11px 16px;background:var(--bg-2);border:1px solid rgba(255,255,255,.08);border-left:3px solid var(--indigo);border-radius:var(--radius-sm);font-size:13px;font-weight:600;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:ti .3s ease;max-width:300px}
.toast.ok{border-left-color:var(--emerald)}.toast.err{border-left-color:var(--rose)}.toast.warn{border-left-color:var(--amber)}
@keyframes ti{from{transform:translateX(28px);opacity:0}to{transform:translateX(0);opacity:1}}

/* EMPTY */
.empty{display:flex;flex-direction:column;align-items:center;gap:12px;padding:56px;color:var(--text-3);text-align:center}
.empty i{font-size:42px;opacity:.2}
.empty p{font-size:13px;max-width:260px;line-height:1.6}

footer.pf{text-align:center;padding:28px;font-size:12px;color:var(--text-3)}
footer.pf a{color:var(--indigo)}
</style>
</head>
<body>
<div class="bg-orbs"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="orb orb-3"></div></div>
<div id="toasts"></div>

<!-- Settings Overlay -->
<div class="s-overlay" id="sOv" onclick="closeS()"></div>
<div class="s-panel" id="sP">
  <div class="s-title"><i class="fa-solid fa-gear"></i>Configuration</div>
  <div class="s-grid">
    <div class="s-field">
      <label><i class="fa-solid fa-server"></i>Backend URL</label>
      <input type="url" id="cfgUrl" class="s-input" placeholder="https://your-space.hf.space">
      <div class="s-hint"><i class="fa-solid fa-triangle-exclamation"></i>No trailing slash</div>
    </div>
    <div class="s-field">
      <label><i class="fa-brands fa-github"></i>GitHub Token</label>
      <input type="password" id="cfgToken" class="s-input" placeholder="ghp_xxxxxxxxxxxx">
      <div class="s-hint"><i class="fa-solid fa-triangle-exclamation"></i>repo:write scope needed</div>
    </div>
    <div class="s-field">
      <label><i class="fa-solid fa-user"></i>GitHub Owner</label>
      <input type="text" id="cfgOwner" class="s-input" placeholder="rafsan1711">
    </div>
    <div class="s-field">
      <label><i class="fa-solid fa-code-branch"></i>Repo Name</label>
      <input type="text" id="cfgRepo" class="s-input" placeholder="geoai">
    </div>
    <div class="s-field full">
      <label><i class="fa-solid fa-code-branch"></i>Branch</label>
      <input type="text" id="cfgBranch" class="s-input" placeholder="main" value="main">
    </div>
  </div>
  <div class="s-row">
    <div class="s-conc-label"><i class="fa-solid fa-bolt" style="color:var(--amber);margin-right:6px"></i>Batch size (parallel games per batch)</div>
    <div class="s-conc-ctrl">
      <button onclick="adjB(-5)">âˆ’</button>
      <span class="s-conc-val" id="batchVal">10</span>
      <button onclick="adjB(5)">+</button>
    </div>
  </div>
  <div class="s-hint" style="margin-top:8px"><i class="fa-solid fa-circle-info"></i>Default 10 = safe for gunicorn 2 workers. Increase if backend is fast.</div>
  <div class="s-actions">
    <button class="btn btn-ghost btn-sm" onclick="closeS()"><i class="fa-solid fa-xmark"></i>Cancel</button>
    <button class="btn btn-primary btn-sm" onclick="saveS()"><i class="fa-solid fa-floppy-disk"></i>Save & Close</button>
  </div>
</div>

<div id="app">
  <nav class="navbar">
    <a href="/" class="nav-logo">
      <div class="nav-logo-icon">ğŸŒ</div><span>GeoAI</span>
      <span class="nav-badge">Bot v2.1</span>
    </a>
    <div class="nav-sp"></div>
    <a href="/" class="nav-btn"><i class="fa-solid fa-house"></i><span>Home</span></a>
    <a href="https://github.com/rafsan1711/geoai" target="_blank" class="nav-btn"><i class="fa-brands fa-github"></i><span>Repo</span></a>
    <button class="nav-btn" id="sBtnT" onclick="toggleS()"><i class="fa-solid fa-gear"></i><span>Config</span></button>
  </nav>

  <section class="hero">
    <div class="hero-badge"><i class="fa-solid fa-robot"></i>Automated Accuracy Benchmark</div>
    <h1 class="hero-title">GeoAI Bot Runner</h1>
    <p class="hero-sub">Simulates games for every country, generates per-country debug reports and a comprehensive analytical REPORT.md.</p>
    <div class="cfg-status">
      <span class="cfg-pill warn" id="pBackend"><i class="fa-solid fa-circle"></i>Backend: Not Set</span>
      <span class="cfg-pill warn" id="pGithub"><i class="fa-solid fa-circle"></i>GitHub: Not Set</span>
      <span class="cfg-pill warn" id="pHealth"><i class="fa-solid fa-circle"></i>Health: Unknown</span>
    </div>
    <div class="run-ctrls">
      <button class="btn btn-primary" id="runBtn" onclick="startRun()"><i class="fa-solid fa-play"></i>Run All Countries</button>
      <button class="btn btn-danger" id="stopBtn" onclick="stopRun()" style="display:none"><i class="fa-solid fa-stop"></i>Stop</button>
      <button class="btn btn-ghost" id="pushBtn" onclick="pushResults()" disabled><i class="fa-brands fa-github"></i>Push to GitHub</button>
      <button class="btn btn-ghost" id="dlBtn" onclick="downloadReport()" disabled><i class="fa-solid fa-download"></i>Download Report</button>
    </div>
    <div class="live-bar" id="liveBar">
      <div class="live-dot"></div>
      <div class="live-txt">Elapsed: <span id="tEl">0s</span> &nbsp;|&nbsp; ETA: <span id="tEta">â€”</span> &nbsp;|&nbsp; Rate: <span id="tRate">â€”</span></div>
    </div>
  </section>

  <div class="wrap">
    <!-- Stats -->
    <div class="stats-bar">
      <div class="stat-item"><div class="sv blue" id="sTotal">â€”</div><div class="sl">Total</div></div>
      <div class="stat-item"><div class="sv purple" id="sDone">0</div><div class="sl">Done</div></div>
      <div class="stat-item"><div class="sv green" id="sOk">0</div><div class="sl">Correct</div></div>
      <div class="stat-item"><div class="sv red" id="sFail">0</div><div class="sl">Wrong</div></div>
      <div class="stat-item"><div class="sv amber" id="sAcc">â€”</div><div class="sl">Accuracy</div></div>
      <div class="stat-item"><div class="sv cyan" id="sAvg">â€”</div><div class="sl">Avg Qs</div></div>
    </div>
    <!-- Progress -->
    <div class="prog-wrap">
      <div class="prog-hdr">
        <div class="prog-lbl"><i class="fa-solid fa-chart-simple"></i>Progress</div>
        <div class="prog-meta" id="progMeta">Not started</div>
      </div>
      <div class="prog-track"><div class="prog-fill" id="progFill" style="width:0%"></div></div>
    </div>
    <!-- Grid -->
    <div id="cGrid"><div class="empty"><i class="fa-solid fa-earth-americas"></i><p>Set Backend URL then click <b>Run All Countries</b></p></div></div>

    <!-- Report -->
    <div id="reportSec" style="display:none">
      <div class="sec-hdr">
        <div class="sec-hdr-title"><i class="fa-solid fa-file-lines"></i>REPORT.md Preview</div>
        <div class="sec-sp"></div>
        <button class="btn btn-ghost btn-sm" onclick="toggleReport()"><i class="fa-solid fa-chevron-down"></i>Toggle</button>
      </div>
      <div class="report-box" id="reportBox"><pre class="report-pre" id="reportPre"></pre></div>
    </div>

    <!-- Console -->
    <div class="sec-hdr">
      <div class="sec-hdr-title"><i class="fa-solid fa-terminal"></i>Console</div>
      <div class="sec-sp"></div>
      <button class="btn btn-ghost btn-sm" onclick="clearLog()"><i class="fa-solid fa-trash"></i>Clear</button>
    </div>
    <div class="log-box" id="logBox"></div>
  </div>

  <footer class="pf">GeoAI Bot Runner v2.1 &nbsp;Â·&nbsp; <a href="https://github.com/rafsan1711/geoai">github.com/rafsan1711/geoai</a> &nbsp;Â·&nbsp; GPL-3.0</footer>
</div>

<!-- Drawer -->
<div class="drw-ov" id="drwOv" onclick="closeDrawer()"></div>
<div class="drw" id="drw">
  <div class="drw-handle"><div class="drw-handle-bar"></div></div>
  <div class="drw-hdr">
    <span class="drw-flag" id="dFlag">ğŸ³</span>
    <div><div class="drw-cname" id="dName">â€”</div><div class="drw-csub" id="dSub">â€”</div></div>
    <button class="drw-close" onclick="closeDrawer()"><i class="fa-solid fa-xmark"></i></button>
  </div>
  <div class="drw-banner pending" id="dBanner"><i class="fa-solid fa-clock"></i><span id="dBannerTxt">Not run yet</span></div>
  <div class="drw-body" id="dBody"><div class="drw-ph"><i class="fa-solid fa-file-code"></i><p>Run this country to see debug report</p></div></div>
  <div class="drw-acts">
    <button class="btn btn-ghost btn-sm" id="dDlBtn" onclick="downloadCountry()" style="display:none"><i class="fa-solid fa-download"></i>Download MD</button>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE â€” mirroring Old-bot.html's working structure
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STATE = {
    config: { backendUrl:'', githubToken:'', githubOwner:'rafsan1711', githubRepo:'geoai', githubBranch:'main' },
    countries: [],
    questions: [],   // â† flat array: questions.country[]
    results: {},     // name â†’ { status, guessed, questionsAsked, confidence, prediction, mdContent }
    running: false,
    stopFlag: false,
    runStartTime: null,
    currentDrawer: null,
    batchSize: 10,
    stat: { total:0, ran:0, correct:0, wrong:0 },
    // analytics
    qStats: {},      // attr â†’ { asked, totalDelta, correct, wrong }
    confusion: {},   // actual â†’ { guessed â†’ count }
    contStats: {},   // cont â†’ { total, correct, wrong, totalQ, fastest, slowest }
};

const CONTINENT_META = {
    asia:         {label:'Asia',          emoji:'ğŸŒ'},
    europe:       {label:'Europe',        emoji:'ğŸŒ'},
    africa:       {label:'Africa',        emoji:'ğŸŒ'},
    northamerica: {label:'North America', emoji:'ğŸŒ'},
    southamerica: {label:'South America', emoji:'ğŸŒ'},
    oceania:      {label:'Oceania',       emoji:'ğŸŒ'},
};
const ORDINAL = {
    population: ['tiny','small','medium','large','verylarge','huge'],
    size:       ['verysmall','small','medium','large','verylarge'],
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleS(){
    const p=document.getElementById('sP'),o=document.getElementById('sOv'),b=document.getElementById('sBtnT');
    const open=p.classList.contains('open');
    if(!open){
        document.getElementById('cfgUrl').value=STATE.config.backendUrl;
        document.getElementById('cfgToken').value=STATE.config.githubToken;
        document.getElementById('cfgOwner').value=STATE.config.githubOwner;
        document.getElementById('cfgRepo').value=STATE.config.githubRepo;
        document.getElementById('cfgBranch').value=STATE.config.githubBranch;
        document.getElementById('batchVal').textContent=STATE.batchSize;
    }
    p.classList.toggle('open',!open);o.classList.toggle('open',!open);b.classList.toggle('active',!open);
}
function closeS(){
    document.getElementById('sP').classList.remove('open');
    document.getElementById('sOv').classList.remove('open');
    document.getElementById('sBtnT').classList.remove('active');
}
function saveS(){
    STATE.config.backendUrl   = document.getElementById('cfgUrl').value.trim().replace(/\/$/,'');
    STATE.config.githubToken  = document.getElementById('cfgToken').value.trim();
    STATE.config.githubOwner  = document.getElementById('cfgOwner').value.trim()||'rafsan1711';
    STATE.config.githubRepo   = document.getElementById('cfgRepo').value.trim()||'geoai';
    STATE.config.githubBranch = document.getElementById('cfgBranch').value.trim()||'main';
    STATE.batchSize           = parseInt(document.getElementById('batchVal').textContent)||10;
    closeS(); refreshPills(); toast('Settings saved','ok');
    log('Config saved. Backend: '+STATE.config.backendUrl,'info');
}
function adjB(d){
    const el=document.getElementById('batchVal');
    el.textContent=Math.max(1,Math.min(195,parseInt(el.textContent||'10')+d));
}
function refreshPills(){
    const pb=document.getElementById('pBackend'),pg=document.getElementById('pGithub');
    if(STATE.config.backendUrl){pb.className='cfg-pill ok';pb.innerHTML='<i class="fa-solid fa-circle-check"></i>Backend: Set';}
    else{pb.className='cfg-pill error';pb.innerHTML='<i class="fa-solid fa-circle-xmark"></i>Backend: Missing';}
    if(STATE.config.githubToken){pg.className='cfg-pill ok';pg.innerHTML='<i class="fa-solid fa-circle-check"></i>GitHub: Set';}
    else{pg.className='cfg-pill warn';pg.innerHTML='<i class="fa-solid fa-circle"></i>GitHub: Not Set';}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA LOADING â€” exact same as Old-bot.html
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadData(){
    log('Loading countries.json and questions.jsonâ€¦','info');
    try{
        const [cR,qR]=await Promise.all([fetch('data/countries.json'),fetch('data/questions.json')]);
        if(!cR.ok) throw new Error('Cannot load data/countries.json');
        if(!qR.ok) throw new Error('Cannot load data/questions.json');
        STATE.countries = await cR.json();
        const qFull     = await qR.json();
        // questions.json = { country:[...], city:[...], place:[...] }
        STATE.questions = qFull.country || (Array.isArray(qFull) ? qFull : []);
        STATE.stat.total = STATE.countries.length;
        document.getElementById('sTotal').textContent = STATE.countries.length;
        log(`Loaded ${STATE.countries.length} countries, ${STATE.questions.length} questions`,'ok');
        return true;
    } catch(e){
        log('Failed to load data: '+e.message,'err');
        toast('Data load failed: '+e.message,'err');
        return false;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEALTH CHECK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function checkHealth(){
    const ph=document.getElementById('pHealth');
    ph.className='cfg-pill warn';ph.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>Checkingâ€¦';
    try{
        const r=await fetch(STATE.config.backendUrl+'/health',{signal:AbortSignal.timeout(8000)});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const d=await r.json();
        if(d.status==='healthy'){
            ph.className='cfg-pill ok';ph.innerHTML='<i class="fa-solid fa-circle-check"></i>Healthy';
            log('Backend healthy: '+JSON.stringify(d.data_stats),'ok');
            return true;
        } else throw new Error('Not healthy');
    } catch(e){
        ph.className='cfg-pill error';ph.innerHTML='<i class="fa-solid fa-circle-xmark"></i>Offline';
        log('Health check failed: '+e.message,'err');
        return false;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API CALL â€” same as Old-bot.html (no retries, simple)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function apiCall(endpoint, method, data){
    const url=STATE.config.backendUrl+endpoint;
    const res=await fetch(url,{
        method,
        headers:{'Content-Type':'application/json'},
        body: data ? JSON.stringify(data) : undefined,
        signal: AbortSignal.timeout(60000)
    });
    if(!res.ok){
        const err=await res.json().catch(()=>({}));
        throw new Error(err.error||`HTTP ${res.status}`);
    }
    return res.json();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOT ANSWER LOGIC â€” enhanced from Old-bot.html
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function botAnswer(country, question){
    const attr=question.attribute, val=question.value;
    if(!(attr in country)) return 'dontknow';
    const cv=country[attr];

    // Boolean
    if(typeof val==='boolean') return cv===val ? 'yes' : 'no';

    // Array (flagColors, neighbors, famousFor, exportsâ€¦)
    if(Array.isArray(cv)){
        const v=String(val).toLowerCase();
        if(cv.some(x=>String(x).toLowerCase()===v)) return 'yes';
        if(cv.some(x=>String(x).toLowerCase().includes(v)||v.includes(String(x).toLowerCase()))) return 'probably';
        return 'no';
    }

    const cvs=String(cv).toLowerCase(), qvs=String(val).toLowerCase();
    if(cvs===qvs) return 'yes';

    // Ordinal ranges (population, size)
    for(const [ordAttr,order] of Object.entries(ORDINAL)){
        if(attr===ordAttr){
            const ci=order.indexOf(cvs), qi=order.indexOf(qvs);
            if(ci!==-1&&qi!==-1){
                const d=Math.abs(ci-qi);
                if(d===0) return 'yes';
                if(d===1) return 'probably';
                if(d===2) return 'probablynot';
                return 'no';
            }
        }
    }
    return 'no';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLAY ONE GAME â€” exact logic from Old-bot.html
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function playGame(country){
    const debugEntries=[];
    let sessionId, questionsAsked=0, finalPrediction=null, finalConfidence=0;

    // Start game
    const startRes=await apiCall('/api/start-game','POST',{
        category:'country',
        questions: STATE.questions   // â† flat array, correct!
    });
    sessionId=startRes.session_id;

    // Q&A loop
    for(let round=0;round<200;round++){
        if(STATE.stopFlag) throw new Error('STOPPED');

        const qRes=await apiCall('/api/question','POST',{session_id:sessionId});
        questionsAsked=qRes.questions_asked||questionsAsked;
        finalConfidence=qRes.confidence||finalConfidence;

        if(qRes.ready_to_guess||!qRes.question) break;

        const q=qRes.question;
        const answer=botAnswer(country,q);

        const entry={
            qNum: questionsAsked+1,
            question: q.question,
            attr: q.attribute,
            val: q.value,
            topBefore: qRes.top_countries||[],
            confBefore: qRes.confidence||0,
            activeBefore: qRes.active_items_count||0,
            answer,
            topAfter:[], confAfter:null, activeAfter:null
        };

        const aRes=await apiCall('/api/answer','POST',{session_id:sessionId, answer});
        entry.topAfter    = aRes.top_countries||[];
        entry.confAfter   = aRes.confidence||0;
        entry.activeAfter = aRes.active_items_count||0;
        questionsAsked    = aRes.questions_asked||questionsAsked+1;
        finalConfidence   = aRes.confidence||finalConfidence;
        debugEntries.push(entry);

        // Analytics: per-attribute effectiveness
        const delta=(entry.confAfter-entry.confBefore);
        if(!STATE.qStats[entry.attr]) STATE.qStats[entry.attr]={asked:0,totalDelta:0,wins:0,total:0};
        STATE.qStats[entry.attr].asked++;
        STATE.qStats[entry.attr].totalDelta+=delta;
        STATE.qStats[entry.attr].total++;

        if(aRes.should_stop) break;
    }

    // Predict
    const predRes=await apiCall('/api/predict','POST',{session_id:sessionId});
    finalPrediction=predRes.prediction?.name||null;
    questionsAsked=predRes.questions_asked||questionsAsked;
    finalConfidence=predRes.confidence||finalConfidence;

    const guessed=finalPrediction&&finalPrediction.toLowerCase()===country.name.toLowerCase();

    // Analytics: confusion + continent
    debugEntries.forEach(e=>{
        if(guessed) STATE.qStats[e.attr].wins++;
    });
    if(!guessed&&finalPrediction){
        if(!STATE.confusion[country.name]) STATE.confusion[country.name]={};
        STATE.confusion[country.name][finalPrediction]=(STATE.confusion[country.name][finalPrediction]||0)+1;
    }
    const cont=country.continent||'unknown';
    if(!STATE.contStats[cont]) STATE.contStats[cont]={total:0,correct:0,wrong:0,totalQ:0,fastest:null,slowest:null};
    const cs=STATE.contStats[cont];
    cs.total++; cs.totalQ+=questionsAsked;
    if(guessed){cs.correct++;if(!cs.fastest||questionsAsked<cs.fastest.q)cs.fastest={name:country.name,q:questionsAsked};}
    else cs.wrong++;
    if(!cs.slowest||questionsAsked>cs.slowest.q)cs.slowest={name:country.name,q:questionsAsked};

    debugEntries.push({type:'GUESS',predictedName:finalPrediction,confidence:finalConfidence,questionsAsked});
    const mdContent=buildDebugMd(country,debugEntries,guessed,finalPrediction,finalConfidence,questionsAsked);
    return{guessed,prediction:finalPrediction,questionsAsked,confidence:finalConfidence,mdContent};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RUN ORCHESTRATION â€” batch parallel (same as working old bot)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function startRun(){
    if(STATE.running) return;
    if(!STATE.config.backendUrl){toast('Set Backend URL in Config first','warn');toggleS();return;}
    if(!STATE.countries.length){ const ok=await loadData(); if(!ok) return; }
    const healthy=await checkHealth();
    if(!healthy){toast('Backend offline. Cannot run.','err');return;}

    STATE.running=true; STATE.stopFlag=false;
    STATE.stat={total:STATE.countries.length,ran:0,correct:0,wrong:0};
    STATE.results={}; STATE.qStats={}; STATE.confusion={}; STATE.contStats={};
    STATE.runStartTime=Date.now();
    STATE.countries.forEach(c=>{STATE.results[c.name]={status:'pending',guessed:false,questionsAsked:0,confidence:0,prediction:null,mdContent:''};});

    renderGrid(); updateStats();
    document.getElementById('runBtn').disabled=true;
    document.getElementById('runBtn').classList.add('btn-running');
    document.getElementById('stopBtn').style.display='';
    document.getElementById('pushBtn').disabled=true;
    document.getElementById('dlBtn').disabled=true;
    document.getElementById('reportSec').style.display='none';
    document.getElementById('liveBar').classList.add('on');

    startTimer();
    const BATCH=STATE.batchSize;
    const total=STATE.countries.length;
    log(`Starting run: ${total} countries, batch size=${BATCH}â€¦`,'info');

    let completed=0;
    for(let i=0;i<total;i+=BATCH){
        if(STATE.stopFlag){log('Run stopped by user.','warn');break;}

        const batch=STATE.countries.slice(i,i+BATCH);
        const bn=Math.floor(i/BATCH)+1, tb=Math.ceil(total/BATCH);
        log(`Batch ${bn}/${tb}: ${batch.map(c=>c.name).join(', ')}`,'info');
        batch.forEach(c=>setCardStatus(c.name,'running'));

        const results=await Promise.allSettled(batch.map(c=>playGame(c)));

        results.forEach((res,idx)=>{
            const country=batch[idx];
            if(STATE.stopFlag){setCardStatus(country.name,'pending');return;}
            if(res.status==='fulfilled'){
                const r=res.value;
                STATE.results[country.name]={status:r.guessed?'correct':'wrong',guessed:r.guessed,questionsAsked:r.questionsAsked,confidence:r.confidence,prediction:r.prediction,mdContent:r.mdContent};
                STATE.stat.ran++;
                if(r.guessed) STATE.stat.correct++; else STATE.stat.wrong++;
                setCardStatus(country.name,r.guessed?'correct':'wrong',r.questionsAsked);
                log(`  ${r.guessed?'âœ…':'âŒ'} ${country.name} â†’ "${r.prediction}" | ${r.questionsAsked}q | ${r.confidence}%`,r.guessed?'ok':'err');
            } else {
                const msg=res.reason?.message||'Unknown error';
                STATE.results[country.name].status='wrong';
                STATE.stat.ran++; STATE.stat.wrong++;
                setCardStatus(country.name,'wrong');
                log(`  âŒ ${country.name} â€” Error: ${msg}`,'err');
            }
        });
        completed+=batch.length;
        updateStats(); updateProg(completed,total);
    }

    // Finalize
    STATE.running=false;
    stopTimer();
    document.getElementById('runBtn').disabled=false;
    document.getElementById('runBtn').classList.remove('btn-running');
    document.getElementById('stopBtn').style.display='none';
    document.getElementById('liveBar').classList.remove('on');

    if(STATE.stat.ran>0){
        const md=buildReportMd();
        document.getElementById('reportPre').textContent=md;
        document.getElementById('reportSec').style.display='';
        document.getElementById('reportBox').classList.add('open');
        document.getElementById('pushBtn').disabled=!STATE.config.githubToken;
        document.getElementById('dlBtn').disabled=false;
        const acc=((STATE.stat.correct/STATE.stat.ran)*100).toFixed(1);
        log(`\nğŸ Done! Accuracy: ${acc}% (${STATE.stat.correct}/${STATE.stat.ran}) | ${elapsedStr()}`,'ok');
        toast(`Done! ${acc}% accuracy`,'ok');
    }
    updateStats();
}

function stopRun(){
    STATE.stopFlag=true; STATE.running=false;
    document.getElementById('stopBtn').style.display='none';
    log('Stop requestedâ€¦','warn');
    toast('Stopping after current batchâ€¦','warn');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _timer=null;
function startTimer(){
    stopTimer();
    _timer=setInterval(()=>{
        document.getElementById('tEl').textContent=elapsedStr();
        const elapsed=(Date.now()-STATE.runStartTime)/1000;
        const done=STATE.stat.ran, total=STATE.stat.total;
        if(done>0&&elapsed>0){
            const rate=done/elapsed;
            document.getElementById('tRate').textContent=(rate*60).toFixed(1)+'/min';
            const rem=total-done;
            document.getElementById('tEta').textContent=rem>0?fmtSec(rem/rate):'Done';
        }
    },500);
}
function stopTimer(){clearInterval(_timer);_timer=null;}
function elapsedStr(){return fmtSec((Date.now()-(STATE.runStartTime||Date.now()))/1000);}
function fmtSec(s){const m=Math.floor(s/60),sec=Math.floor(s%60);return m>0?`${m}m ${sec}s`:`${sec}s`;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GRID RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderGrid(){
    const grid=document.getElementById('cGrid');
    grid.innerHTML='';
    const groups={};
    STATE.countries.forEach(c=>{const k=c.continent||'unknown';if(!groups[k])groups[k]=[];groups[k].push(c);});

    Object.entries(groups).forEach(([cont,countries])=>{
        const meta=CONTINENT_META[cont]||{label:cont,emoji:'ğŸŒ'};
        const sec=document.createElement('div');
        sec.className='cont-sec open';
        sec.innerHTML=`
          <div class="cont-hdr" onclick="this.closest('.cont-sec').classList.toggle('open');this.querySelector('.cont-chev').style.transform=this.closest('.cont-sec').classList.contains('open')?'rotate(180deg)':''">
            <span class="cont-emoji">${meta.emoji}</span>
            <span class="cont-name">${meta.label}</span>
            <span class="cont-acc" id="cacc-${cont}">â€”</span>
            <div class="cont-pw"><div class="cont-pf" data-cont="${cont}" style="width:0%"></div></div>
            <span class="cont-cnt" data-cc="${cont}">0/${countries.length}</span>
            <i class="fa-solid fa-chevron-down cont-chev" style="transform:rotate(180deg)"></i>
          </div>
          <div class="cont-body" id="body-${cont}"></div>`;
        const body=sec.querySelector('.cont-body');
        countries.forEach(c=>{
            const card=document.createElement('div');
            card.className='c-card s-pending';
            card.id='card-'+enc(c.name);
            card.onclick=()=>openDrawer(c.name);
            card.innerHTML=`
              <span class="c-flag">${c.emoji||'ğŸ³'}</span>
              <div class="c-info">
                <div class="c-name">${c.name}</div>
                <div class="c-meta">${c.region||''}${c.subRegion?' Â· '+c.subRegion:''}</div>
              </div>
              <span class="c-qb" id="qb-${enc(c.name)}"></span>
              <span class="c-ico s-pending" id="ico-${enc(c.name)}"><i class="fa-regular fa-clock"></i></span>`;
            body.appendChild(card);
        });
        grid.appendChild(sec);
    });
}
function enc(n){return n.replace(/[^a-zA-Z0-9]/g,'_');}

function setCardStatus(name,status,q){
    const id=enc(name);
    const card=document.getElementById('card-'+id);
    const ico=document.getElementById('ico-'+id);
    const qb=document.getElementById('qb-'+id);
    if(!card) return;
    card.className='c-card s-'+status;
    const icons={pending:'<i class="fa-regular fa-clock"></i>',running:'<i class="fa-solid fa-spinner"></i>',correct:'<i class="fa-solid fa-circle-check"></i>',wrong:'<i class="fa-solid fa-circle-xmark"></i>'};
    if(ico){ico.className='c-ico s-'+status;ico.innerHTML=icons[status]||'';}
    if(q!==undefined&&qb){qb.style.display='inline';qb.textContent=q+'q';}
    const cont=STATE.countries.find(c=>c.name===name)?.continent;
    if(cont) updateContProg(cont);
}

function updateContProg(cont){
    const cs=STATE.countries.filter(c=>c.continent===cont);
    const done=cs.filter(c=>{const r=STATE.results[c.name];return r&&r.status!=='pending';}).length;
    const correct=cs.filter(c=>STATE.results[c.name]?.guessed).length;
    const fill=document.querySelector(`.cont-pf[data-cont="${cont}"]`);
    const cc=document.querySelector(`[data-cc="${cont}"]`);
    const aEl=document.getElementById('cacc-'+cont);
    if(fill) fill.style.width=(done/cs.length*100)+'%';
    if(cc) cc.textContent=`${done}/${cs.length}`;
    if(aEl&&done>0){
        const pct=correct/done;
        aEl.textContent=(pct*100).toFixed(0)+'%';
        aEl.className='cont-acc '+(pct>=.9?'good':pct<.7?'bad':'');
    }
}

function updateStats(){
    document.getElementById('sTotal').textContent=STATE.stat.total||'â€”';
    document.getElementById('sDone').textContent=STATE.stat.ran;
    document.getElementById('sOk').textContent=STATE.stat.correct;
    document.getElementById('sFail').textContent=STATE.stat.wrong;
    document.getElementById('sAcc').textContent=STATE.stat.ran?(STATE.stat.correct/STATE.stat.ran*100).toFixed(1)+'%':'â€”';
    const comp=Object.values(STATE.results).filter(r=>r.status!=='pending'&&r.questionsAsked);
    const avg=comp.length?(comp.reduce((a,r)=>a+r.questionsAsked,0)/comp.length).toFixed(1):'â€”';
    document.getElementById('sAvg').textContent=avg;
}
function updateProg(done,total){
    const pct=Math.round(done/total*100);
    document.getElementById('progFill').style.width=pct+'%';
    document.getElementById('progMeta').textContent=`${done} / ${total} (${pct}%)`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAWER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openDrawer(name){
    const c=STATE.countries.find(x=>x.name===name);
    if(!c) return;
    STATE.currentDrawer=name;
    document.getElementById('dFlag').textContent=c.emoji||'ğŸ³';
    document.getElementById('dName').textContent=c.name;
    document.getElementById('dSub').textContent=[c.continent,c.region,c.subRegion].filter(Boolean).join(' Â· ');
    const r=STATE.results[name];
    const banner=document.getElementById('dBanner'), bt=document.getElementById('dBannerTxt'), dlBtn=document.getElementById('dDlBtn'), body=document.getElementById('dBody');
    if(!r||r.status==='pending'){
        banner.className='drw-banner pending';banner.querySelector('i').className='fa-solid fa-clock';bt.textContent='Not run yet';
        body.innerHTML='<div class="drw-ph"><i class="fa-solid fa-file-code"></i><p>Run this country to see debug report</p></div>';
        dlBtn.style.display='none';
    } else {
        if(r.guessed){banner.className='drw-banner correct';banner.querySelector('i').className='fa-solid fa-circle-check';bt.textContent=`Correct in ${r.questionsAsked}q â€” ${r.confidence}% confidence`;}
        else{banner.className='drw-banner wrong';banner.querySelector('i').className='fa-solid fa-circle-xmark';bt.textContent=`Wrong â€” guessed "${r.prediction}" | ${r.questionsAsked}q | ${r.confidence}%`;}
        body.innerHTML=`<pre class="drw-md">${esc(r.mdContent)}</pre>`;
        dlBtn.style.display='';
    }
    document.getElementById('drwOv').classList.add('open');
    document.getElementById('drw').classList.add('open');
}
function closeDrawer(){document.getElementById('drwOv').classList.remove('open');document.getElementById('drw').classList.remove('open');STATE.currentDrawer=null;}
function downloadCountry(){
    const r=STATE.results[STATE.currentDrawer];
    if(!r?.mdContent) return;
    blob(r.mdContent,STATE.currentDrawer+'.md','text/markdown');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleReport(){document.getElementById('reportBox').classList.toggle('open');}
function downloadReport(){const md=document.getElementById('reportPre').textContent;if(md)blob(md,'REPORT.md','text/markdown');}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GITHUB PUSH â€” FIXED: no encodeURIComponent on path
   (Old-bot used encodeURIComponent which caused 404 forbidden)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function pushResults(){
    if(!STATE.config.githubToken){toast('GitHub token not set','warn');return;}
    const ran=Object.entries(STATE.results).filter(([,r])=>r.status!=='pending');
    if(!ran.length){toast('No results to push','warn');return;}

    document.getElementById('pushBtn').disabled=true;
    toast('Pushing to GitHubâ€¦','info');
    log('Starting GitHub pushâ€¦','info');

    const {githubOwner:owner,githubRepo:repo,githubBranch:branch,githubToken:token}=STATE.config;
    const base=`https://api.github.com/repos/${owner}/${repo}/contents/`;
    const headers={
        'Authorization':'Bearer '+token,
        'Content-Type':'application/json',
        'Accept':'application/vnd.github.v3+json',
        'X-GitHub-Api-Version':'2022-11-28'
    };

    let pushed=0, failed=0;
    for(const [name,r] of ran){
        if(!r.mdContent) continue;
        const path=`Debug/Countries/${name}.md`;
        try{
            await ghPut(base,path,r.mdContent,branch,headers,`bot: debug ${name}`);
            pushed++;
            if(pushed%10===0) log(`  Pushed ${pushed} filesâ€¦`,'info');
        } catch(e){failed++;log(`  Failed: ${name} â€” ${e.message}`,'err');}
    }
    try{
        await ghPut(base,'Debug/REPORT.md',buildReportMd(),branch,headers,'bot: update REPORT.md');
        log('Pushed Debug/REPORT.md','ok');
    } catch(e){log('Failed REPORT.md: '+e.message,'err');failed++;}

    document.getElementById('pushBtn').disabled=false;
    log(`Push done. ${pushed} pushed, ${failed} failed.`,failed?'warn':'ok');
    toast(`Pushed ${pushed} files (${failed} failed)`,failed?'warn':'ok');
}

async function ghPut(base, path, content, branch, headers, message){
    // CRITICAL FIX: Do NOT use encodeURIComponent on path â€” GitHub API accepts raw path
    // Old-bot used encodeURIComponent which caused 404 on files with spaces/special chars
    const apiPath = path; // keep raw

    // Get SHA if file exists (required for update)
    let sha=undefined;
    try{
        const r=await fetch(base+apiPath+'?ref='+branch,{headers});
        if(r.ok){const d=await r.json();if(d.sha)sha=d.sha;}
    } catch(_){}

    const body={message, content:btoa(unescape(encodeURIComponent(content))), branch};
    if(sha) body.sha=sha;

    const res=await fetch(base+apiPath,{method:'PUT',headers,body:JSON.stringify(body)});
    if(!res.ok){
        const err=await res.json().catch(()=>({}));
        throw new Error(err.message||`HTTP ${res.status}`);
    }
    return res.json();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEBUG MD PER COUNTRY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildDebugMd(country, entries, guessed, finalPred, finalConf, questionsAsked){
    const L=[], now=new Date().toISOString();
    L.push(`# GeoAI Debug Report â€” ${country.emoji||''} ${country.name}`);
    L.push('');L.push('## ğŸ“‹ Summary');L.push('');
    L.push('| Field | Value |');L.push('|-------|-------|');
    L.push(`| Country | ${country.emoji||''} **${country.name}** |`);
    L.push(`| Continent | ${country.continent||'â€”'} |`);
    L.push(`| Region | ${country.region||'â€”'} |`);
    L.push(`| Sub-Region | ${country.subRegion||'â€”'} |`);
    L.push(`| Population | ${country.population||'â€”'} |`);
    L.push(`| Result | ${guessed?'âœ… **CORRECT**':'âŒ **WRONG**'} |`);
    L.push(`| AI Guessed | ${finalPred||'â€”'} |`);
    L.push(`| Confidence | ${finalConf}% |`);
    L.push(`| Questions Asked | ${questionsAsked} |`);
    L.push(`| Generated | ${now} |`);
    L.push('');
    if(!guessed&&finalPred) L.push(`> âš ï¸ AI thought of **${finalPred}** instead of **${country.name}**\n`);
    L.push('---');L.push('');L.push('## ğŸ” Question Log');L.push('');

    entries.forEach((e,i)=>{
        if(e.type==='GUESS'){
            L.push('## ğŸ¯ Final Guess');L.push('');
            L.push('| | |');L.push('|--|--|');
            L.push(`| **Prediction** | ${e.predictedName||'â€”'} |`);
            L.push(`| **Confidence** | ${e.confidence}% |`);
            L.push(`| **Questions Asked** | ${e.questionsAsked} |`);
            L.push(`| **Verdict** | ${guessed?'âœ… CORRECT':'âŒ WRONG'} |`);
            return;
        }
        const aLabel={yes:'âœ… Yes',probably:'ğŸŸ¡ Probably',dontknow:"â“ Don't Know",probablynot:'ğŸŸ  Probably Not',no:'âŒ No'}[e.answer]||e.answer;
        const delta=e.confAfter!==null?(e.confAfter-e.confBefore).toFixed(1):null;
        const arrow=delta===null?'':parseFloat(delta)>0?'ğŸ“ˆ':parseFloat(delta)<0?'ğŸ“‰':'â¡ï¸';
        L.push(`### Q${i+1}: ${e.question}`);L.push('');
        L.push(`- **Attribute:** \`${e.attr}\` = \`${e.val}\``);
        L.push(`- **Answer:** ${aLabel}`);
        if(delta!==null) L.push(`- **Confidence:** ${e.confBefore}% â†’ ${e.confAfter}% ${arrow} (${parseFloat(delta)>0?'+':''}${delta})`);
        L.push(`- **Active Countries:** ${e.activeBefore} â†’ ${e.activeAfter}`);
        L.push('');
        if(e.topBefore?.length){
            L.push('**Before:**');
            L.push('| # | Country | Prob |');L.push('|---|---------|------|');
            e.topBefore.forEach((c,j)=>L.push(`| ${j+1} | ${c.name} | ${c.prob}% |`));
            L.push('');
        }
        if(e.topAfter?.length){
            const bMap={};(e.topBefore||[]).forEach(c=>bMap[c.name]=c.prob);
            L.push('**After:**');
            L.push('| # | Country | Prob | Î” |');L.push('|---|---------|------|---|');
            e.topAfter.forEach((c,j)=>{
                const prev=bMap[c.name];
                const d=prev!==undefined?(c.prob-prev).toFixed(2):'new';
                const a=d==='new'?'ğŸ†•':parseFloat(d)>0?`+${d}%ğŸ“ˆ`:parseFloat(d)<0?`${d}%ğŸ“‰`:'Â±0%';
                L.push(`| ${j+1} | ${c.name} | ${c.prob}% | ${a} |`);
            });
            L.push('');
        }
        L.push('---');L.push('');
    });
    return L.join('\n');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROFESSIONAL REPORT.md â€” 9 SECTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildReportMd(){
    const now=new Date();
    const results=STATE.results;
    const countries=STATE.countries;
    const ran=Object.entries(results).filter(([,r])=>r.status!=='pending');
    const correct=ran.filter(([,r])=>r.guessed).length;
    const wrong=ran.length-correct;
    const acc=ran.length?(correct/ran.length*100).toFixed(2):'0.00';
    const totalQ=ran.reduce((a,[,r])=>a+r.questionsAsked,0);
    const avgQ=ran.length?(totalQ/ran.length).toFixed(1):'â€”';
    const elapsed=STATE.runStartTime?fmtSec((now-STATE.runStartTime)/1000):'â€”';

    const L=[];
    L.push('# ğŸŒ GeoAI Bot Test â€” Analytical Report');
    L.push('');
    L.push(`> **Generated:** ${now.toUTCString()}`);
    L.push(`> **Run Duration:** ${elapsed}  |  **Batch Size:** ${STATE.batchSize}  |  **Bot Version:** v2.1`);
    L.push('');L.push('---');L.push('');

    // Â§ 1 Executive Summary
    L.push('## ğŸ“Š Â§1 Executive Summary');L.push('');
    L.push('| Metric | Value | Notes |');L.push('|--------|-------|-------|');
    L.push(`| **Overall Accuracy** | **${acc}%** | Target: â‰¥95% |`);
    L.push(`| Countries Tested | ${ran.length} / ${countries.length} | ${countries.length-ran.length} skipped |`);
    L.push(`| Correct | âœ… ${correct} | |`);
    L.push(`| Wrong | âŒ ${wrong} | |`);
    L.push(`| Avg Questions/Country | ${avgQ} | Lower = smarter |`);
    L.push(`| Total Questions Asked | ${totalQ} | |`);
    L.push(`| Run Duration | ${elapsed} | |`);
    L.push(`| Status | ${parseFloat(acc)>=95?'âœ… TARGET MET':parseFloat(acc)>=85?'âš ï¸ BELOW TARGET':'âŒ NEEDS WORK'} | |`);
    L.push('');

    // Â§ 2 Continent Breakdown
    const contArr=Object.entries(STATE.contStats).map(([cont,d])=>{
        const meta=CONTINENT_META[cont]||{label:cont,emoji:'ğŸŒ'};
        return{cont,meta,cAcc:d.total?(d.correct/d.total*100).toFixed(1):'0.0',cAvgQ:d.total?(d.totalQ/d.total).toFixed(1):'â€”',...d};
    }).sort((a,b)=>parseFloat(b.cAcc)-parseFloat(a.cAcc));

    L.push('---');L.push('');L.push('## ğŸŒ Â§2 Performance by Continent');L.push('');
    L.push('| Continent | Total | âœ… | âŒ | Accuracy | Avg Q | Fastest | Slowest |');
    L.push('|-----------|-------|----|----|----------|-------|---------|---------|');
    contArr.forEach(({meta,total,correct:c,wrong:w,cAcc,cAvgQ,fastest:f,slowest:sl})=>{
        const bar='â–ˆ'.repeat(Math.round(parseFloat(cAcc)/10))+'â–‘'.repeat(10-Math.round(parseFloat(cAcc)/10));
        L.push(`| ${meta.emoji} **${meta.label}** | ${total} | ${c} | ${w} | **${cAcc}%** \`${bar}\` | ${cAvgQ}q | ${f?f.name+'('+f.q+'q)':'â€”'} | ${sl?sl.name+'('+sl.q+'q)':'â€”'} |`);
    });
    L.push('');
    contArr.forEach(({meta,cAcc,wrong:w})=>{
        const p=parseFloat(cAcc);
        if(p<80) L.push(`- âš ï¸ **${meta.label}** underperforming at ${cAcc}% â€” ${w} wrong. Add more discriminative questions for this region.`);
        else if(p>=95) L.push(`- âœ… **${meta.label}** excellent at ${cAcc}%`);
    });
    L.push('');

    // Â§ 3 Speed Analysis
    L.push('---');L.push('');L.push('## âš¡ Â§3 Speed Analysis');L.push('');
    const ranArr=ran.map(([name,r])=>({name,...r}));
    L.push('### ğŸ† Top 10 Fastest Correct Guesses');L.push('');
    L.push('| # | Country | Questions | Confidence |');L.push('|---|---------|-----------|------------|');
    [...ranArr].filter(r=>r.guessed).sort((a,b)=>a.questionsAsked-b.questionsAsked).slice(0,10).forEach((r,i)=>{
        const c=countries.find(x=>x.name===r.name);
        L.push(`| ${i+1} | ${c?.emoji||''} ${r.name} | **${r.questionsAsked}q** | ${r.confidence}% |`);
    });
    L.push('');
    L.push('### ğŸ¢ Top 10 Slowest Correct Guesses');L.push('');
    L.push('| # | Country | Questions | Confidence |');L.push('|---|---------|-----------|------------|');
    [...ranArr].filter(r=>r.guessed).sort((a,b)=>b.questionsAsked-a.questionsAsked).slice(0,10).forEach((r,i)=>{
        const c=countries.find(x=>x.name===r.name);
        L.push(`| ${i+1} | ${c?.emoji||''} ${r.name} | **${r.questionsAsked}q** | ${r.confidence}% |`);
    });
    L.push('');

    // Â§ 4 Wrong Answers
    const wrongList=ranArr.filter(r=>!r.guessed);
    L.push('---');L.push('');L.push('## âŒ Â§4 Failed Cases');L.push('');
    if(!wrongList.length){
        L.push('> ğŸ‰ **Perfect score!** No wrong answers.');
    } else {
        L.push(`> ${wrongList.length} wrong guesses. Fix these to improve accuracy.`);L.push('');
        L.push('| # | Country | AI Guessed | Questions | Confidence | Debug |');
        L.push('|---|---------|------------|-----------|------------|-------|');
        wrongList.forEach((r,i)=>{
            const c=countries.find(x=>x.name===r.name);
            L.push(`| ${i+1} | ${c?.emoji||''} **${r.name}** | ${r.prediction||'â€”'} | ${r.questionsAsked}q | ${r.confidence}% | [Debug](Countries/${r.name}.md) |`);
        });
    }
    L.push('');

    // Â§ 5 Confusion Analysis
    const confPairs=[];
    Object.entries(STATE.confusion).forEach(([actual,guesses])=>{
        Object.entries(guesses).forEach(([g,cnt])=>confPairs.push({actual,guessed:g,count:cnt}));
    });
    confPairs.sort((a,b)=>b.count-a.count);
    L.push('---');L.push('');L.push('## ğŸ”€ Â§5 Confusion Analysis');L.push('');
    if(!confPairs.length){
        L.push('> No confusion data (all correct or run incomplete).');
    } else {
        L.push('| # | Actual | Confused With | Action |');L.push('|---|--------|---------------|--------|');
        confPairs.slice(0,20).forEach((p,i)=>{
            const ca=countries.find(c=>c.name===p.actual);
            const cg=countries.find(c=>c.name===p.guessed);
            const sameR=ca?.region===cg?.region;
            const hint=sameR?'Same region â€” add sub-region/language Q':'Different region â€” check data';
            L.push(`| ${i+1} | ${ca?.emoji||''} **${p.actual}** | ${cg?.emoji||''} ${p.guessed} (${p.count}x) | ${hint} |`);
        });
    }
    L.push('');

    // Â§ 6 Question Effectiveness
    const qEffArr=Object.entries(STATE.qStats).map(([attr,d])=>({
        attr, asked:d.asked,
        avgDelta:d.asked?(d.totalDelta/d.asked).toFixed(2):'0',
        winRate:d.total>0?((d.wins/d.total)*100).toFixed(0):'â€”'
    })).sort((a,b)=>parseFloat(b.avgDelta)-parseFloat(a.avgDelta));
    L.push('---');L.push('');L.push('## ğŸ“ˆ Â§6 Question Attribute Effectiveness');L.push('');
    L.push('> **Avg Conf Î”** = avg confidence change per question. Higher = more useful.');L.push('');
    L.push('| # | Attribute | Asked | Avg Conf Î” | Win Rate | Verdict |');
    L.push('|---|-----------|-------|-----------|----------|---------|');
    qEffArr.forEach((q,i)=>{
        const d=parseFloat(q.avgDelta);
        const v=d>5?'ğŸ”¥ Highly Effective':d>2?'âœ… Effective':d>0?'ğŸŸ¡ Moderate':'ğŸ”´ Weak';
        L.push(`| ${i+1} | \`${q.attr}\` | ${q.asked} | **${d>0?'+':''}${q.avgDelta}%** | ${q.winRate}% | ${v} |`);
    });
    L.push('');
    const weak=qEffArr.filter(q=>parseFloat(q.avgDelta)<=0);
    const strong=qEffArr.filter(q=>parseFloat(q.avgDelta)>5);
    if(strong.length) L.push(`**â†‘ Increase weight for:** ${strong.map(q=>`\`${q.attr}\``).join(', ')}\n`);
    if(weak.length) L.push(`**â†“ Review/Remove:** ${weak.map(q=>`\`${q.attr}\``).join(', ')}\n`);

    // Â§ 7 Algorithm Tuning
    L.push('---');L.push('');L.push('## ğŸ”§ Â§7 Algorithm Tuning Suggestions');L.push('');
    const oa=parseFloat(acc);
    if(oa<95) L.push(`1. **Accuracy Gap:** ${(95-oa).toFixed(2)}% below 95% target â†’ fix ${wrongList.length} failing countries.`);
    if(confPairs.length) L.push(`2. **Top Confusion:** "${confPairs[0].actual}" â†” "${confPairs[0].guessed}" â€” add discriminating question.`);
    const slowCont=contArr.sort((a,b)=>parseFloat(a.cAcc)-parseFloat(b.cAcc))[0];
    if(slowCont) L.push(`3. **Weakest Continent:** ${slowCont.meta.emoji} ${slowCont.meta.label} (${slowCont.cAcc}%) â€” expand question bank.`);
    if(qEffArr[0]) L.push(`4. **Best Attribute:** \`${qEffArr[0].attr}\` (avg Î”=${qEffArr[0].avgDelta}%) â€” ensure asked early (Stage 0).`);
    const worst=qEffArr[qEffArr.length-1];
    if(worst&&parseFloat(worst.avgDelta)<=0) L.push(`5. **Weakest Attribute:** \`${worst.attr}\` (avg Î”=${worst.avgDelta}%) â€” consider removing.`);
    const slowC=ranArr.filter(r=>r.questionsAsked>20);
    if(slowC.length) L.push(`6. **Slow Countries (>20q):** ${slowC.length} countries â€” check for missing unique attributes.`);
    L.push('');

    // Â§ 8 Full Index
    L.push('---');L.push('');L.push('## ğŸ“ Â§8 Full Country Index');L.push('');
    L.push('| Country | Result | Questions | Confidence | AI Guessed | Debug |');
    L.push('|---------|--------|-----------|------------|------------|-------|');
    [...ranArr].sort((a,b)=>a.name.localeCompare(b.name)).forEach(r=>{
        const c=countries.find(x=>x.name===r.name);
        L.push(`| ${c?.emoji||''} ${r.name} | ${r.guessed?'âœ…':'âŒ'} | ${r.questionsAsked}q | ${r.confidence}% | ${r.prediction||'â€”'} | [Debug](Countries/${r.name}.md) |`);
    });
    L.push('');

    // Â§ 9 Data Quality Flags
    L.push('---');L.push('');L.push('## ğŸ´ Â§9 Data Quality Flags');L.push('');
    const poorData=wrongList.filter(r=>r.questionsAsked>20);
    if(!poorData.length){
        L.push('> No data quality flags.');
    } else {
        L.push('Countries that are wrong AND slow (>20q) â€” likely missing unique attributes:');L.push('');
        L.push('| Country | Questions | Confused With |');L.push('|---------|-----------|---------------|');
        poorData.forEach(r=>{
            const c=countries.find(x=>x.name===r.name);
            L.push(`| ${c?.emoji||''} **${r.name}** | ${r.questionsAsked}q | ${r.prediction||'â€”'} |`);
        });
    }
    L.push('');L.push('---');
    L.push(`*GeoAI Bot Runner v2.1 â€” ${now.toUTCString()}*`);
    return L.join('\n');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function log(msg,type=''){
    const box=document.getElementById('logBox');
    const ts=new Date().toTimeString().slice(0,8);
    const d=document.createElement('div');
    d.className='log-line';
    d.innerHTML=`<span class="log-ts">[${ts}]</span><span class="${type?'log-'+type:''}">${esc(msg)}</span>`;
    box.appendChild(d); box.scrollTop=box.scrollHeight;
}
function clearLog(){document.getElementById('logBox').innerHTML='';log('Log cleared.','info');}
function toast(msg,type=''){
    const c=document.getElementById('toasts');
    const t=document.createElement('div');
    t.className='toast '+(type||'');t.textContent=msg;
    c.appendChild(t); setTimeout(()=>t.remove(),4000);
}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function blob(content,fname,mime){
    const u=URL.createObjectURL(new Blob([content],{type:mime}));
    const a=document.createElement('a');a.href=u;a.download=fname;
    document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded',()=>{
    refreshPills();
    log('GeoAI Bot Runner v2.1 ready.','info');
    log('â–¸ Game logic: exact same as old-bot.html (verified working)','info');
    log('â–¸ questions.json: auto-extracts questions.country[] flat array','info');
    log('â–¸ GitHub push: fixed â€” no encodeURIComponent on file paths','info');
    log('â–¸ Batch default: 10 (safe for gunicorn 2-worker). Adjust in Config.','info');
    log('Click Config â†’ set Backend URL â†’ Run All Countries','info');
});
</script>
</body>
</html>
