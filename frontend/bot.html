<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a0a0f">
    <title>GeoAI Â· Bot Test Runner</title>

    <!-- Font Awesome 6 via cdnjs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DESIGN TOKENS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    :root {
        --bg-0:   #070710;
        --bg-1:   #0d0d1a;
        --bg-2:   #13132a;
        --bg-3:   #1a1a38;
        --surface: #1e1e3f;
        --surface-2: #252550;

        --indigo:  #6366f1;
        --indigo-2:#4f46e5;
        --purple:  #8b5cf6;
        --cyan:    #06b6d4;
        --emerald: #10b981;
        --amber:   #f59e0b;
        --rose:    #f43f5e;
        --slate:   #64748b;

        --text-1: #f1f5f9;
        --text-2: #94a3b8;
        --text-3: #64748b;

        --radius: 14px;
        --radius-sm: 8px;
        --radius-lg: 20px;
        --transition: 0.25s cubic-bezier(.4,0,.2,1);

        --panel-w: 440px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESET & BASE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
        height: 100%;
        background: var(--bg-0);
        color: var(--text-1);
        font-family: 'Inter', system-ui, sans-serif;
        font-size: 15px;
        overflow-x: hidden;
    }

    /* scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--surface-2); border-radius: 99px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BACKGROUND DECORATION
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .bg-orbs {
        position: fixed; inset: 0; pointer-events: none; z-index: 0;
        overflow: hidden;
    }
    .orb {
        position: absolute; border-radius: 50%;
        filter: blur(120px); opacity: 0.18;
        animation: orb-drift 12s ease-in-out infinite alternate;
    }
    .orb-1 { width:600px; height:600px; background:var(--indigo); top:-200px; left:-150px; }
    .orb-2 { width:500px; height:500px; background:var(--purple); bottom:-150px; right:-100px; animation-delay:-6s; }
    .orb-3 { width:300px; height:300px; background:var(--cyan);   top:40%;    left:45%;      animation-delay:-3s; }
    @keyframes orb-drift {
        from { transform: translate(0,0) scale(1); }
        to   { transform: translate(30px,20px) scale(1.05); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LAYOUT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #app {
        position: relative; z-index: 1;
        min-height: 100vh;
        display: flex; flex-direction: column;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOP NAVBAR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .navbar {
        position: sticky; top: 0; z-index: 200;
        display: flex; align-items: center; gap: 12px;
        padding: 0 24px; height: 60px;
        background: rgba(7,7,16,.82);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(99,102,241,.15);
    }
    .navbar-logo {
        display: flex; align-items: center; gap: 10px;
        text-decoration: none; color: var(--text-1);
    }
    .navbar-logo-icon {
        width: 32px; height: 32px;
        background: linear-gradient(135deg, var(--indigo), var(--purple));
        border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        font-size: 16px;
    }
    .navbar-logo-text { font-weight: 700; font-size: 16px; }
    .navbar-logo-badge {
        font-size: 10px; font-weight: 600;
        background: linear-gradient(90deg,var(--indigo),var(--purple));
        color: #fff; padding: 2px 7px; border-radius: 99px;
        text-transform: uppercase; letter-spacing: .5px;
    }
    .navbar-spacer { flex: 1; }
    .navbar-btn {
        display: flex; align-items: center; gap: 8px;
        padding: 7px 14px; border-radius: var(--radius-sm);
        border: 1px solid rgba(255,255,255,.08);
        background: rgba(255,255,255,.04);
        color: var(--text-2); font-size: 13px; font-family: inherit;
        cursor: pointer; transition: var(--transition);
        text-decoration: none;
    }
    .navbar-btn:hover { background: rgba(255,255,255,.08); color: var(--text-1); }
    .navbar-btn i { font-size: 14px; }
    #settingsToggle.active {
        background: rgba(99,102,241,.2);
        border-color: var(--indigo);
        color: var(--indigo);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SETTINGS PANEL (slides down from top)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .settings-overlay {
        position: fixed; inset: 0; z-index: 150;
        background: rgba(0,0,0,.5);
        backdrop-filter: blur(4px);
        opacity: 0; pointer-events: none;
        transition: opacity var(--transition);
    }
    .settings-overlay.open { opacity: 1; pointer-events: all; }

    .settings-panel {
        position: fixed; top: 60px; left: 50%; transform: translateX(-50%) translateY(-20px);
        z-index: 160;
        width: min(640px, calc(100vw - 32px));
        background: var(--bg-2);
        border: 1px solid rgba(99,102,241,.25);
        border-radius: var(--radius-lg);
        box-shadow: 0 32px 80px rgba(0,0,0,.7), 0 0 0 1px rgba(99,102,241,.1);
        padding: 28px;
        opacity: 0; pointer-events: none;
        transition: opacity .3s ease, transform .3s ease;
    }
    .settings-panel.open {
        opacity: 1; pointer-events: all;
        transform: translateX(-50%) translateY(0);
    }

    .settings-title {
        display: flex; align-items: center; gap: 10px;
        font-size: 17px; font-weight: 700; margin-bottom: 24px;
    }
    .settings-title i { color: var(--indigo); }

    .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media(max-width:520px) { .settings-grid { grid-template-columns: 1fr; } }

    .settings-field {
        display: flex; flex-direction: column; gap: 6px;
    }
    .settings-field label {
        font-size: 12px; font-weight: 600; color: var(--text-3);
        text-transform: uppercase; letter-spacing: .5px;
        display: flex; align-items: center; gap: 6px;
    }
    .settings-field label i { color: var(--indigo); font-size: 11px; }

    .settings-input {
        background: var(--bg-3); border: 1px solid rgba(255,255,255,.08);
        border-radius: var(--radius-sm); color: var(--text-1);
        font-family: 'JetBrains Mono', monospace; font-size: 13px;
        padding: 10px 14px; outline: none;
        transition: border-color var(--transition);
        width: 100%;
    }
    .settings-input:focus { border-color: var(--indigo); }
    .settings-input::placeholder { color: var(--text-3); }
    input[type="password"].settings-input { letter-spacing: 3px; }
    input[type="password"].settings-input:focus { letter-spacing: normal; }

    .settings-full { grid-column: 1 / -1; }

    .settings-hint {
        font-size: 11px; color: var(--text-3); margin-top: 3px;
        display: flex; align-items: center; gap: 5px;
    }
    .settings-hint i { color: var(--amber); }

    .settings-actions {
        display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BUTTONS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .btn {
        display: inline-flex; align-items: center; gap: 8px;
        padding: 10px 20px; border-radius: var(--radius-sm);
        border: none; cursor: pointer;
        font-family: inherit; font-size: 14px; font-weight: 600;
        transition: var(--transition); text-decoration: none;
        white-space: nowrap;
    }
    .btn i { font-size: 14px; }
    .btn-primary {
        background: linear-gradient(135deg, var(--indigo), var(--purple));
        color: #fff; box-shadow: 0 4px 20px rgba(99,102,241,.35);
    }
    .btn-primary:hover { filter: brightness(1.12); transform: translateY(-1px); }
    .btn-primary:active { transform: translateY(0); }
    .btn-ghost {
        background: transparent;
        border: 1px solid rgba(255,255,255,.1);
        color: var(--text-2);
    }
    .btn-ghost:hover { background: rgba(255,255,255,.06); color: var(--text-1); }
    .btn-danger {
        background: rgba(244,63,94,.12);
        border: 1px solid rgba(244,63,94,.3);
        color: var(--rose);
    }
    .btn-danger:hover { background: rgba(244,63,94,.22); }
    .btn-sm { padding: 7px 14px; font-size: 13px; }
    .btn:disabled { opacity: .4; pointer-events: none; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HERO SECTION
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .hero {
        text-align: center;
        padding: 80px 24px 48px;
    }
    .hero-badge {
        display: inline-flex; align-items: center; gap: 8px;
        background: rgba(99,102,241,.12);
        border: 1px solid rgba(99,102,241,.3);
        color: var(--indigo); padding: 6px 16px;
        border-radius: 99px; font-size: 13px; font-weight: 600;
        margin-bottom: 24px;
    }
    .hero-badge i { font-size: 12px; }
    .hero-title {
        font-size: clamp(32px, 5vw, 56px);
        font-weight: 900; line-height: 1.1;
        letter-spacing: -1px; margin-bottom: 16px;
        background: linear-gradient(135deg, var(--text-1) 40%, var(--indigo));
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .hero-sub {
        font-size: 17px; color: var(--text-2); max-width: 520px;
        margin: 0 auto 40px; line-height: 1.65;
    }

    .hero-warning {
        display: flex; align-items: center; gap: 10px;
        background: rgba(245,158,11,.08); border: 1px solid rgba(245,158,11,.25);
        border-radius: var(--radius); padding: 14px 18px;
        max-width: 540px; margin: 0 auto 40px;
        font-size: 13px; color: var(--amber); text-align: left;
    }
    .hero-warning i { font-size: 16px; flex-shrink: 0; }
    .hero-warning span { color: var(--text-2); }
    .hero-warning span b { color: var(--amber); }

    .config-status {
        display: flex; align-items: center; justify-content: center; gap: 10px;
        margin-bottom: 32px; flex-wrap: wrap;
    }
    .config-pill {
        display: inline-flex; align-items: center; gap: 6px;
        padding: 5px 12px; border-radius: 99px; font-size: 12px; font-weight: 600;
        border: 1px solid;
    }
    .config-pill.ok    { background: rgba(16,185,129,.1); border-color: rgba(16,185,129,.3); color: var(--emerald); }
    .config-pill.warn  { background: rgba(245,158,11,.1); border-color: rgba(245,158,11,.3); color: var(--amber); }
    .config-pill.error { background: rgba(244,63,94,.1);  border-color: rgba(244,63,94,.3);  color: var(--rose); }
    .config-pill i { font-size: 11px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RUN CONTROLS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .run-controls {
        display: flex; align-items: center; gap: 12px;
        justify-content: center; flex-wrap: wrap;
    }

    /* Pulse ring on start btn while running */
    .btn-start-running {
        animation: pulse-ring 1.5s ease-in-out infinite;
    }
    @keyframes pulse-ring {
        0%,100% { box-shadow: 0 4px 20px rgba(99,102,241,.35); }
        50%      { box-shadow: 0 4px 32px rgba(99,102,241,.7), 0 0 0 8px rgba(99,102,241,.12); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STATS BAR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .stats-bar {
        display: flex; gap: 0;
        background: var(--bg-2);
        border: 1px solid rgba(255,255,255,.06);
        border-radius: var(--radius);
        max-width: 860px; margin: 40px auto 0;
        overflow: hidden;
    }
    .stat-item {
        flex: 1; padding: 18px 20px;
        border-right: 1px solid rgba(255,255,255,.06);
        text-align: center;
    }
    .stat-item:last-child { border-right: none; }
    .stat-val {
        font-size: 26px; font-weight: 800;
        line-height: 1; margin-bottom: 4px;
        font-variant-numeric: tabular-nums;
    }
    .stat-val.green  { color: var(--emerald); }
    .stat-val.red    { color: var(--rose); }
    .stat-val.blue   { color: var(--cyan); }
    .stat-val.purple { color: var(--purple); }
    .stat-val.amber  { color: var(--amber); }
    .stat-label { font-size: 11px; color: var(--text-3); font-weight: 600;
        text-transform: uppercase; letter-spacing: .5px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MAIN CONTENT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .main-content {
        max-width: 1100px; margin: 0 auto;
        padding: 32px 24px 80px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PROGRESS SECTION
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .section-header {
        display: flex; align-items: center; gap: 10px;
        margin-bottom: 20px;
    }
    .section-title {
        font-size: 16px; font-weight: 700;
        display: flex; align-items: center; gap: 8px;
    }
    .section-title i { color: var(--indigo); }
    .section-spacer { flex: 1; }
    .section-meta { font-size: 12px; color: var(--text-3); font-variant-numeric: tabular-nums; }

    .overall-progress-bar {
        height: 6px; background: var(--bg-3);
        border-radius: 99px; overflow: hidden; margin-bottom: 32px;
    }
    .overall-progress-fill {
        height: 100%; border-radius: 99px;
        background: linear-gradient(90deg, var(--indigo), var(--purple), var(--cyan));
        background-size: 200% 100%;
        transition: width .4s ease;
        animation: shimmer 2s linear infinite;
    }
    @keyframes shimmer {
        0%  { background-position: 200% center; }
        100%{ background-position: -200% center; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONTINENT ACCORDION
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .continent-section {
        margin-bottom: 16px;
        border: 1px solid rgba(255,255,255,.06);
        border-radius: var(--radius);
        overflow: hidden;
        background: var(--bg-1);
    }
    .continent-header {
        display: flex; align-items: center; gap: 12px;
        padding: 14px 18px;
        cursor: pointer; user-select: none;
        transition: background var(--transition);
        background: var(--bg-2);
    }
    .continent-header:hover { background: var(--bg-3); }
    .continent-emoji { font-size: 20px; }
    .continent-name { font-weight: 700; font-size: 15px; }
    .continent-progress-wrap {
        flex: 1; background: var(--bg-3); height: 5px;
        border-radius: 99px; overflow: hidden; margin: 0 8px;
    }
    .continent-progress-fill {
        height: 100%; border-radius: 99px;
        background: linear-gradient(90deg, var(--emerald), var(--cyan));
        transition: width .5s ease;
    }
    .continent-counts { font-size: 12px; color: var(--text-3); font-variant-numeric: tabular-nums; white-space:nowrap; }
    .continent-chevron {
        color: var(--text-3); font-size: 12px;
        transition: transform var(--transition);
    }
    .continent-section.open .continent-chevron { transform: rotate(180deg); }
    .continent-body {
        display: none; padding: 14px 16px;
        display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr));
        gap: 8px;
    }
    .continent-section:not(.open) .continent-body { display: none; }
    .continent-section.open .continent-body { display: grid; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       COUNTRY CARD
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .country-card {
        display: flex; align-items: center; gap: 10px;
        padding: 10px 12px; border-radius: var(--radius-sm);
        background: var(--bg-2);
        border: 1px solid rgba(255,255,255,.05);
        transition: border-color var(--transition), background var(--transition);
        cursor: pointer; min-width: 0;
    }
    .country-card:hover { border-color: rgba(99,102,241,.3); background: var(--bg-3); }
    .country-card.status-pending  { border-color: rgba(255,255,255,.05); }
    .country-card.status-running  { border-color: var(--indigo); background: rgba(99,102,241,.07);
        animation: card-pulse .8s ease-in-out infinite alternate; }
    .country-card.status-correct  { border-color: rgba(16,185,129,.3); background: rgba(16,185,129,.06); }
    .country-card.status-wrong    { border-color: rgba(244,63,94,.3);  background: rgba(244,63,94,.06); }

    @keyframes card-pulse {
        from { box-shadow: 0 0 0 0 rgba(99,102,241,.15); }
        to   { box-shadow: 0 0 0 6px rgba(99,102,241,.0); }
    }

    .country-flag { font-size: 20px; flex-shrink: 0; line-height:1; }
    .country-info { flex: 1; min-width: 0; }
    .country-name {
        font-size: 13px; font-weight: 600; white-space: nowrap;
        overflow: hidden; text-overflow: ellipsis;
    }
    .country-meta { font-size: 11px; color: var(--text-3); margin-top: 1px; white-space: nowrap;
        overflow: hidden; text-overflow: ellipsis; }
    .country-status-icon { font-size: 15px; flex-shrink: 0; }
    .country-status-icon.pending  { color: var(--text-3); }
    .country-status-icon.running  { color: var(--indigo); animation: spin .8s linear infinite; }
    .country-status-icon.correct  { color: var(--emerald); }
    .country-status-icon.wrong    { color: var(--rose); }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DETAIL DRAWER (bottom slide-up panel for country detail)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .drawer-overlay {
        position: fixed; inset: 0; z-index: 300;
        background: rgba(0,0,0,.6);
        backdrop-filter: blur(4px);
        opacity: 0; pointer-events: none;
        transition: opacity .3s ease;
    }
    .drawer-overlay.open { opacity: 1; pointer-events: all; }

    .drawer {
        position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(100%);
        z-index: 310;
        width: min(700px, 100vw);
        max-height: 80vh;
        background: var(--bg-2);
        border: 1px solid rgba(99,102,241,.25);
        border-bottom: none;
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        padding: 0 0 40px;
        transition: transform .35s cubic-bezier(.32,.72,0,1);
        overflow-y: auto;
        display: flex; flex-direction: column;
    }
    .drawer.open { transform: translateX(-50%) translateY(0); }

    .drawer-handle {
        display: flex; justify-content: center;
        padding: 14px 0 0;
    }
    .drawer-handle-bar {
        width: 40px; height: 4px;
        background: var(--surface-2); border-radius: 99px;
    }
    .drawer-header {
        display: flex; align-items: center; gap: 12px;
        padding: 18px 24px 0;
    }
    .drawer-flag { font-size: 36px; }
    .drawer-country-name { font-size: 22px; font-weight: 800; }
    .drawer-country-sub  { font-size: 13px; color: var(--text-3); margin-top: 2px; }
    .drawer-close {
        margin-left: auto; background: transparent; border: none;
        color: var(--text-3); font-size: 18px; cursor: pointer;
        padding: 8px; border-radius: 8px;
        transition: var(--transition);
    }
    .drawer-close:hover { color: var(--text-1); background: rgba(255,255,255,.06); }

    .drawer-result-banner {
        margin: 16px 24px 0;
        padding: 12px 16px; border-radius: var(--radius-sm);
        display: flex; align-items: center; gap: 10px;
        font-weight: 600; font-size: 14px;
    }
    .drawer-result-banner.correct { background: rgba(16,185,129,.12); border: 1px solid rgba(16,185,129,.3); color: var(--emerald); }
    .drawer-result-banner.wrong   { background: rgba(244,63,94,.12);  border: 1px solid rgba(244,63,94,.3);  color: var(--rose); }
    .drawer-result-banner.pending { background: rgba(99,102,241,.1);  border: 1px solid rgba(99,102,241,.25); color: var(--indigo); }
    .drawer-result-banner i { font-size: 16px; }

    .drawer-body { padding: 16px 24px 0; flex: 1; }

    .drawer-md {
        font-size: 13px; line-height: 1.7;
        font-family: 'JetBrains Mono', monospace;
        color: var(--text-2);
        background: var(--bg-3);
        border-radius: var(--radius-sm);
        padding: 16px; overflow-x: auto;
        max-height: 400px; overflow-y: auto;
        white-space: pre-wrap; word-break: break-word;
        border: 1px solid rgba(255,255,255,.05);
    }
    .drawer-placeholder {
        display: flex; flex-direction: column; align-items: center;
        justify-content: center; gap: 12px; padding: 48px;
        color: var(--text-3);
    }
    .drawer-placeholder i { font-size: 40px; opacity: .4; }

    .drawer-actions {
        display: flex; gap: 10px; padding: 16px 24px 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       REPORT SECTION
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .report-section {
        margin-top: 48px;
    }
    .report-box {
        background: var(--bg-1); border: 1px solid rgba(255,255,255,.06);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }
    .report-box-header {
        display: flex; align-items: center; gap: 10px;
        padding: 18px 24px;
        background: var(--bg-2);
        border-bottom: 1px solid rgba(255,255,255,.06);
        cursor: pointer; user-select: none;
        transition: background var(--transition);
    }
    .report-box-header:hover { background: var(--bg-3); }
    .report-box-title { font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 8px; }
    .report-box-title i { color: var(--amber); }
    .report-box-chevron { margin-left: auto; color: var(--text-3); transition: transform var(--transition); }
    .report-box.open .report-box-chevron { transform: rotate(180deg); }
    .report-box-body { display: none; padding: 24px; }
    .report-box.open .report-box-body { display: block; }

    .report-md {
        font-size: 13px; line-height: 1.8;
        color: var(--text-2);
        background: var(--bg-3);
        border-radius: var(--radius-sm);
        padding: 20px; overflow-x: auto;
        max-height: 600px; overflow-y: auto;
        white-space: pre-wrap; word-break: break-word;
        border: 1px solid rgba(255,255,255,.05);
        font-family: 'JetBrains Mono', monospace;
    }
    /* Markdown render inside .report-md */
    .report-md h1,h2,h3 { font-family: 'Inter', sans-serif; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOG CONSOLE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .log-section { margin-top: 32px; }
    .log-box {
        background: #06060f;
        border: 1px solid rgba(255,255,255,.06);
        border-radius: var(--radius);
        font-family: 'JetBrains Mono', monospace;
        font-size: 12px; color: #94a3b8;
        height: 180px; overflow-y: auto;
        padding: 12px 16px;
    }
    .log-box p { margin-bottom: 2px; }
    .log-box p.log-ok   { color: var(--emerald); }
    .log-box p.log-err  { color: var(--rose); }
    .log-box p.log-info { color: var(--cyan); }
    .log-box p.log-warn { color: var(--amber); }
    .log-ts { color: var(--text-3); margin-right: 8px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FOOTER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .page-footer {
        text-align: center;
        padding: 32px 24px;
        color: var(--text-3); font-size: 12px;
        border-top: 1px solid rgba(255,255,255,.05);
    }
    .page-footer a { color: var(--indigo); text-decoration: none; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOAST
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #toast-container {
        position: fixed; bottom: 24px; right: 24px;
        z-index: 999; display: flex; flex-direction: column;
        gap: 10px; pointer-events: none;
    }
    .toast {
        background: var(--bg-2);
        border: 1px solid rgba(255,255,255,.1);
        border-left: 3px solid var(--indigo);
        border-radius: var(--radius-sm);
        padding: 12px 18px;
        font-size: 13px; color: var(--text-1);
        box-shadow: 0 8px 32px rgba(0,0,0,.5);
        animation: toast-in .3s ease;
        pointer-events: all;
    }
    .toast.ok   { border-left-color: var(--emerald); }
    .toast.err  { border-left-color: var(--rose); }
    .toast.warn { border-left-color: var(--amber); }
    @keyframes toast-in {
        from { transform: translateX(40px); opacity:0; }
        to   { transform: translateX(0);    opacity:1; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       EMPTY / LOADING STATES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .empty-state {
        display: flex; flex-direction: column; align-items: center;
        gap: 12px; padding: 64px 24px; color: var(--text-3);
        text-align: center;
    }
    .empty-state i { font-size: 48px; opacity: .3; }
    .empty-state p { font-size: 14px; max-width: 300px; line-height: 1.5; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media(max-width:600px) {
        .hero { padding: 60px 16px 32px; }
        .stats-bar { flex-wrap: wrap; }
        .stat-item { flex: 1 1 45%; }
        .continent-body { grid-template-columns: 1fr 1fr; }
    }
    </style>
</head>
<body>

<!-- Background -->
<div class="bg-orbs">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<!-- Settings Overlay -->
<div class="settings-overlay" id="settingsOverlay" onclick="closeSettings()"></div>

<!-- Settings Panel -->
<div class="settings-panel" id="settingsPanel">
    <div class="settings-title">
        <i class="fa-solid fa-gear"></i>
        Configuration
    </div>
    <div class="settings-grid">
        <div class="settings-field">
            <label><i class="fa-solid fa-server"></i> Backend URL</label>
            <input type="url" id="cfgBackendUrl" class="settings-input"
                   placeholder="https://your-space.hf.space">
            <div class="settings-hint">
                <i class="fa-solid fa-triangle-exclamation"></i>
                HuggingFace Space URL (no trailing slash)
            </div>
        </div>
        <div class="settings-field">
            <label><i class="fa-brands fa-github"></i> GitHub Token</label>
            <input type="password" id="cfgGithubToken" class="settings-input"
                   placeholder="ghp_xxxxxxxxxxxx">
            <div class="settings-hint">
                <i class="fa-solid fa-triangle-exclamation"></i>
                Needs repo write scope
            </div>
        </div>
        <div class="settings-field">
            <label><i class="fa-solid fa-user"></i> GitHub Owner</label>
            <input type="text" id="cfgGithubOwner" class="settings-input"
                   placeholder="rafsan1711">
        </div>
        <div class="settings-field">
            <label><i class="fa-solid fa-code-branch"></i> Repo Name</label>
            <input type="text" id="cfgGithubRepo" class="settings-input"
                   placeholder="geoai">
        </div>
        <div class="settings-field settings-full">
            <label><i class="fa-solid fa-code-branch"></i> Branch</label>
            <input type="text" id="cfgGithubBranch" class="settings-input"
                   placeholder="main" value="main">
        </div>
    </div>

    <div class="settings-hint" style="margin-top:12px;">
        <i class="fa-solid fa-shield-halved"></i>
        <span>Credentials are stored in <b>session memory only</b> â€” never persisted to localStorage.</span>
    </div>

    <div class="settings-actions">
        <button class="btn btn-ghost btn-sm" onclick="closeSettings()">
            <i class="fa-solid fa-xmark"></i> Cancel
        </button>
        <button class="btn btn-primary btn-sm" onclick="saveSettings()">
            <i class="fa-solid fa-floppy-disk"></i> Save & Close
        </button>
    </div>
</div>

<!-- Main App -->
<div id="app">

    <!-- Navbar -->
    <nav class="navbar">
        <a href="/" class="navbar-logo">
            <div class="navbar-logo-icon">ğŸŒ</div>
            <span class="navbar-logo-text">GeoAI</span>
            <span class="navbar-logo-badge">Bot</span>
        </a>
        <div class="navbar-spacer"></div>
        <a href="/" class="navbar-btn">
            <i class="fa-solid fa-house"></i>
            <span>Home</span>
        </a>
        <a href="https://github.com/rafsan1711/geoai" target="_blank" class="navbar-btn">
            <i class="fa-brands fa-github"></i>
            <span>Repo</span>
        </a>
        <button class="navbar-btn" id="settingsToggle" onclick="toggleSettings()">
            <i class="fa-solid fa-gear"></i>
            <span>Config</span>
        </button>
    </nav>

    <!-- Hero -->
    <section class="hero">
        <div class="hero-badge">
            <i class="fa-solid fa-robot"></i>
            Automated Accuracy Test
        </div>
        <h1 class="hero-title">GeoAI Bot Runner</h1>
        <p class="hero-sub">
            Runs a simulated game session for every country in the dataset.<br>
            Generates debug reports and pushes results to GitHub automatically.
        </p>

        <div class="hero-warning" id="configWarning" style="display:none;">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <span>Configure <b>Backend URL</b> and <b>GitHub Token</b> before running. Click <b>Config</b> above.</span>
        </div>

        <div class="config-status" id="configStatus">
            <span class="config-pill warn" id="pillBackend"><i class="fa-solid fa-circle"></i> Backend: Not Set</span>
            <span class="config-pill warn" id="pillGithub"><i class="fa-solid fa-circle"></i> GitHub: Not Set</span>
            <span class="config-pill warn" id="pillHealth"><i class="fa-solid fa-circle"></i> Health: Unknown</span>
        </div>

        <div class="run-controls">
            <button class="btn btn-primary" id="runBtn" onclick="startRun()">
                <i class="fa-solid fa-play"></i>
                Run All Countries
            </button>
            <button class="btn btn-ghost" id="stopBtn" onclick="stopRun()" style="display:none;">
                <i class="fa-solid fa-stop"></i>
                Stop
            </button>
            <button class="btn btn-ghost" id="pushBtn" onclick="pushResults()" disabled>
                <i class="fa-brands fa-github"></i>
                Push to GitHub
            </button>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <div class="stat-val blue" id="statTotal">â€”</div>
                <div class="stat-label">Total Countries</div>
            </div>
            <div class="stat-item">
                <div class="stat-val purple" id="statRan">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-item">
                <div class="stat-val green" id="statCorrect">0</div>
                <div class="stat-label">Correct</div>
            </div>
            <div class="stat-item">
                <div class="stat-val red" id="statWrong">0</div>
                <div class="stat-label">Wrong</div>
            </div>
            <div class="stat-item">
                <div class="stat-val amber" id="statAcc">â€”</div>
                <div class="stat-label">Accuracy</div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <div class="main-content">

        <!-- Overall progress -->
        <div class="section-header">
            <div class="section-title"><i class="fa-solid fa-chart-simple"></i> Progress</div>
            <div class="section-spacer"></div>
            <div class="section-meta" id="progressMeta">Not started</div>
        </div>
        <div class="overall-progress-bar">
            <div class="overall-progress-fill" id="overallProgressFill" style="width:0%"></div>
        </div>

        <!-- Country grid (grouped by continent) -->
        <div id="countryGrid">
            <div class="empty-state">
                <i class="fa-solid fa-earth-americas"></i>
                <p>Configure the backend URL and click <b>Run All Countries</b> to start.</p>
            </div>
        </div>

        <!-- Report Section -->
        <div class="report-section" id="reportSection" style="display:none;">
            <div class="section-header">
                <div class="section-title"><i class="fa-solid fa-file-lines"></i> Summary Report</div>
            </div>
            <div class="report-box" id="reportBox">
                <div class="report-box-header" onclick="toggleReportBox()">
                    <div class="report-box-title">
                        <i class="fa-solid fa-chart-pie"></i>
                        REPORT.md â€” Full Accuracy Summary
                    </div>
                    <i class="fa-solid fa-chevron-down report-box-chevron"></i>
                </div>
                <div class="report-box-body">
                    <pre class="report-md" id="reportMd"></pre>
                    <div style="display:flex;gap:10px;margin-top:14px;">
                        <button class="btn btn-ghost btn-sm" onclick="downloadReport()">
                            <i class="fa-solid fa-download"></i> Download REPORT.md
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="pushResults()">
                            <i class="fa-brands fa-github"></i> Push to GitHub
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Log Console -->
        <div class="log-section">
            <div class="section-header">
                <div class="section-title"><i class="fa-solid fa-terminal"></i> Console</div>
                <div class="section-spacer"></div>
                <button class="btn btn-ghost btn-sm" onclick="clearLog()">
                    <i class="fa-solid fa-trash"></i> Clear
                </button>
            </div>
            <div class="log-box" id="logBox">
                <p class="log-info"><span class="log-ts">[init]</span> GeoAI Bot Runner ready. Configure and run.</p>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="page-footer">
        GeoAI Bot Runner &nbsp;Â·&nbsp; v1.1.1 &nbsp;Â·&nbsp;
        <a href="https://github.com/rafsan1711/geoai">github.com/rafsan1711/geoai</a> &nbsp;Â·&nbsp;
        GPL-3.0 License
    </footer>

</div>

<!-- Country Detail Drawer -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
<div class="drawer" id="detailDrawer">
    <div class="drawer-handle"><div class="drawer-handle-bar"></div></div>
    <div class="drawer-header">
        <span class="drawer-flag" id="drawerFlag">ğŸ³</span>
        <div>
            <div class="drawer-country-name" id="drawerName">Country</div>
            <div class="drawer-country-sub" id="drawerSub">Region</div>
        </div>
        <button class="drawer-close" onclick="closeDrawer()">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>
    <div class="drawer-result-banner pending" id="drawerBanner">
        <i class="fa-solid fa-clock"></i>
        <span id="drawerBannerText">Not run yet</span>
    </div>
    <div class="drawer-body">
        <div id="drawerContent">
            <div class="drawer-placeholder">
                <i class="fa-solid fa-file-code"></i>
                <p>Run this country to see its debug report</p>
            </div>
        </div>
    </div>
    <div class="drawer-actions">
        <button class="btn btn-ghost btn-sm" id="drawerDownloadBtn" onclick="downloadCountryReport()" style="display:none;">
            <i class="fa-solid fa-download"></i> Download Debug MD
        </button>
    </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STATE = {
    config: {
        backendUrl:    '',
        githubToken:   '',
        githubOwner:   'rafsan1711',
        githubRepo:    'geoai',
        githubBranch:  'main'
    },
    countries:    [],    // loaded from data/countries.json
    questions:    [],    // loaded from data/questions.json
    results:      {},    // { countryName: { status, guessed, questionsAsked, mdContent } }
    running:      false,
    stopFlag:     false,
    runStartTime: null,
    currentDrawer: null,

    stat: { total:0, ran:0, correct:0, wrong:0 }
};

// Answer weights â€” same as backend ALGORITHM_PARAMS
const ANSWER_WEIGHTS = {
    yes:         { match: 5.0,   mismatch: 0.005 },
    probably:    { match: 2.5,   mismatch: 0.2   },
    dontknow:    { match: 1.0,   mismatch: 1.0   },
    probablynot: { match: 0.2,   mismatch: 2.5   },
    no:          { match: 0.005, mismatch: 5.0   }
};

const CONTINENT_META = {
    asia:          { label:'Asia',           emoji:'ğŸŒ' },
    europe:        { label:'Europe',          emoji:'ğŸŒ' },
    africa:        { label:'Africa',          emoji:'ğŸŒ' },
    northamerica:  { label:'North America',   emoji:'ğŸŒ' },
    southamerica:  { label:'South America',   emoji:'ğŸŒ' },
    oceania:       { label:'Oceania',         emoji:'ğŸŒ' },
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleSettings() {
    const panel = document.getElementById('settingsPanel');
    const overlay = document.getElementById('settingsOverlay');
    const btn = document.getElementById('settingsToggle');
    const open = panel.classList.contains('open');
    if (!open) {
        // Populate fields
        document.getElementById('cfgBackendUrl').value    = STATE.config.backendUrl;
        document.getElementById('cfgGithubToken').value   = STATE.config.githubToken;
        document.getElementById('cfgGithubOwner').value   = STATE.config.githubOwner;
        document.getElementById('cfgGithubRepo').value    = STATE.config.githubRepo;
        document.getElementById('cfgGithubBranch').value  = STATE.config.githubBranch;
    }
    panel.classList.toggle('open', !open);
    overlay.classList.toggle('open', !open);
    btn.classList.toggle('active', !open);
}
function closeSettings() {
    document.getElementById('settingsPanel').classList.remove('open');
    document.getElementById('settingsOverlay').classList.remove('open');
    document.getElementById('settingsToggle').classList.remove('active');
}
function saveSettings() {
    const url = document.getElementById('cfgBackendUrl').value.trim().replace(/\/$/, '');
    STATE.config.backendUrl   = url;
    STATE.config.githubToken  = document.getElementById('cfgGithubToken').value.trim();
    STATE.config.githubOwner  = document.getElementById('cfgGithubOwner').value.trim() || 'rafsan1711';
    STATE.config.githubRepo   = document.getElementById('cfgGithubRepo').value.trim()  || 'geoai';
    STATE.config.githubBranch = document.getElementById('cfgGithubBranch').value.trim() || 'main';
    closeSettings();
    updateConfigPills();
    toast('Settings saved for this session', 'ok');
    log('Config saved. Backend: ' + STATE.config.backendUrl, 'info');
}
function updateConfigPills() {
    const pb = document.getElementById('pillBackend');
    const pg = document.getElementById('pillGithub');
    const warn = document.getElementById('configWarning');
    if (STATE.config.backendUrl) {
        pb.className = 'config-pill ok';
        pb.innerHTML = '<i class="fa-solid fa-circle-check"></i> Backend: Set';
    } else {
        pb.className = 'config-pill error';
        pb.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> Backend: Missing';
    }
    if (STATE.config.githubToken) {
        pg.className = 'config-pill ok';
        pg.innerHTML = '<i class="fa-solid fa-circle-check"></i> GitHub: Set';
    } else {
        pg.className = 'config-pill warn';
        pg.innerHTML = '<i class="fa-solid fa-circle"></i> GitHub: Not Set';
    }
    const missing = !STATE.config.backendUrl || !STATE.config.githubToken;
    warn.style.display = missing ? 'flex' : 'none';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA LOADING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadData() {
    log('Loading countries.json and questions.jsonâ€¦', 'info');
    try {
        const [cRes, qRes] = await Promise.all([
            fetch('data/countries.json'),
            fetch('data/questions.json')
        ]);
        if (!cRes.ok) throw new Error('Cannot load data/countries.json');
        if (!qRes.ok) throw new Error('Cannot load data/questions.json');
        const countries = await cRes.json();
        const questions  = await qRes.json();

        STATE.countries = countries;
        STATE.questions  = (questions.country || []);
        STATE.stat.total = countries.length;

        document.getElementById('statTotal').textContent = countries.length;
        log(`Loaded ${countries.length} countries, ${STATE.questions.length} questions`, 'ok');
        return true;
    } catch(e) {
        log('Failed to load data: ' + e.message, 'err');
        toast('Data load failed: ' + e.message, 'err');
        return false;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEALTH CHECK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function checkHealth() {
    const ph = document.getElementById('pillHealth');
    try {
        ph.className = 'config-pill warn';
        ph.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checkingâ€¦';
        const r = await fetch(STATE.config.backendUrl + '/health', { signal: AbortSignal.timeout(8000) });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const d = await r.json();
        if (d.status === 'healthy') {
            ph.className = 'config-pill ok';
            ph.innerHTML = '<i class="fa-solid fa-circle-check"></i> Healthy';
            log('Backend healthy: ' + JSON.stringify(d.data_stats), 'ok');
            return true;
        } else {
            throw new Error('Not healthy');
        }
    } catch(e) {
        ph.className = 'config-pill error';
        ph.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> Offline';
        log('Backend health check failed: ' + e.message, 'err');
        return false;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOT: play one complete game for a given country
   Returns: { guessed: bool, prediction: string, questionsAsked: int, mdContent: string }
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function playGame(country) {
    const debugEntries = [];
    let sessionId;

    // â”€â”€ Start game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const startRes = await apiCall('/api/start-game', 'POST', {
        category: 'country',
        questions: STATE.questions
    });
    sessionId = startRes.session_id;

    // â”€â”€ Question-answer loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let questionsAsked = 0;
    let finalPrediction = null;
    let finalConfidence = 0;

    for (let round = 0; round < 200; round++) {
        if (STATE.stopFlag) throw new Error('STOPPED');

        // Get next question
        const qRes = await apiCall('/api/question', 'POST', { session_id: sessionId });
        questionsAsked = qRes.questions_asked || questionsAsked;
        finalConfidence = qRes.confidence || finalConfidence;

        if (qRes.ready_to_guess || !qRes.question) {
            break; // AI is ready to guess
        }

        const q = qRes.question;

        // â”€â”€ Bot logic: answer based on country attributes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const answer = botAnswer(country, q);

        // Log question entry
        debugEntries.push({
            qNum:        questionsAsked + 1,
            question:    q.question,
            topBefore:   qRes.top_countries || [],
            confBefore:  qRes.confidence,
            activeBefore: qRes.active_items_count,
            answer,
            topAfter:    null,
            confAfter:   null,
            activeAfter: null
        });

        // Submit answer
        const aRes = await apiCall('/api/answer', 'POST', {
            session_id: sessionId,
            answer
        });

        // Complete log entry
        const last = debugEntries[debugEntries.length - 1];
        last.topAfter    = aRes.top_countries || [];
        last.confAfter   = aRes.confidence;
        last.activeAfter = aRes.active_items_count;
        questionsAsked   = aRes.questions_asked || questionsAsked + 1;
        finalConfidence  = aRes.confidence || finalConfidence;

        if (aRes.should_stop) break;
    }

    // â”€â”€ Get prediction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const predRes = await apiCall('/api/predict', 'POST', { session_id: sessionId });
    finalPrediction = predRes.prediction?.name || null;
    questionsAsked  = predRes.questions_asked  || questionsAsked;
    finalConfidence = predRes.confidence        || finalConfidence;

    const guessed = finalPrediction &&
        finalPrediction.toLowerCase() === country.name.toLowerCase();

    // â”€â”€ Debug guess entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    debugEntries.push({ type: 'GUESS', predictedName: finalPrediction, confidence: finalConfidence, questionsAsked });

    // â”€â”€ Generate Markdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const mdContent = generateDebugMd(country, debugEntries, guessed, finalPrediction, finalConfidence);

    return { guessed, prediction: finalPrediction, questionsAsked, confidence: finalConfidence, mdContent };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOT ANSWER LOGIC
   Given a country object and a question, return the right answer string.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function botAnswer(country, question) {
    const attr = question.attribute;
    const val  = question.value;

    if (!(attr in country)) return 'dontknow';

    const countryVal = country[attr];

    // Boolean attributes
    if (typeof val === 'boolean') {
        return countryVal === val ? 'yes' : 'no';
    }

    // Array attributes (e.g. flagColors, neighbors, famousFor)
    if (Array.isArray(countryVal)) {
        const v = String(val).toLowerCase();
        const found = countryVal.some(x => String(x).toLowerCase() === v);
        return found ? 'yes' : 'no';
    }

    // String/number comparison
    const cv = String(countryVal).toLowerCase();
    const qv = String(val).toLowerCase();

    if (cv === qv) return 'yes';

    // Numeric ranges: population, area
    if (attr === 'population') {
        const order = ['tiny','small','medium','large','verylarge','huge'];
        const ci = order.indexOf(cv);
        const qi = order.indexOf(qv);
        if (ci !== -1 && qi !== -1) {
            const diff = Math.abs(ci - qi);
            if (diff === 0) return 'yes';
            if (diff === 1) return 'probably';
            return 'no';
        }
    }

    return 'no';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MARKDOWN GENERATION â€” same style as frontend debug.js
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function generateDebugMd(country, entries, guessed, finalPrediction, finalConfidence) {
    const now = new Date();
    const lines = [];

    lines.push(`# GeoAI Debug Report â€” ${country.name}`);
    lines.push('');
    lines.push('| Field | Value |');
    lines.push('|-------|-------|');
    lines.push(`| Country | ${country.emoji || ''} ${country.name} |`);
    lines.push(`| Continent | ${country.continent || 'â€”'} |`);
    lines.push(`| Region | ${country.region || 'â€”'} |`);
    lines.push(`| Generated | ${now.toISOString()} |`);
    lines.push(`| Result | ${guessed ? 'âœ… Correct' : 'âŒ Wrong'} |`);
    lines.push(`| AI Guessed | ${finalPrediction || 'â€”'} |`);
    lines.push(`| Final Confidence | ${finalConfidence}% |`);
    lines.push('');
    lines.push('---');
    lines.push('');

    entries.forEach(entry => {
        if (entry.type === 'GUESS') {
            lines.push('## ğŸ¯ Final Guess');
            lines.push('');
            lines.push('| | |');
            lines.push('|--|--|');
            lines.push(`| Predicted | **${entry.predictedName}** |`);
            lines.push(`| Confidence | ${entry.confidence}% |`);
            lines.push(`| Questions Asked | ${entry.questionsAsked} |`);
            lines.push('');
            return;
        }

        const answerLabel = {
            yes: 'âœ… Yes', probably: 'ğŸŸ¡ Probably',
            dontknow: "â“ Don't Know", probablynot: 'ğŸŸ  Probably Not', no: 'âŒ No'
        }[entry.answer] || entry.answer;

        lines.push(`## Q${entry.qNum}: ${entry.question}`);
        lines.push('');
        lines.push(`**Answer:** ${answerLabel}`);
        lines.push('');

        const delta = entry.confAfter !== null && entry.confBefore !== null
            ? (entry.confAfter - entry.confBefore).toFixed(1) : null;
        const arrow = delta === null ? '' : parseFloat(delta) > 0 ? 'ğŸ“ˆ' : parseFloat(delta) < 0 ? 'ğŸ“‰' : 'â¡ï¸';
        if (delta !== null) {
            lines.push(`**Confidence:** ${entry.confBefore}% â†’ ${entry.confAfter}% ${arrow} (${delta > 0 ? '+' : ''}${delta})`);
            lines.push('');
        }
        lines.push(`**Active Countries:** ${entry.activeBefore ?? '?'} â†’ ${entry.activeAfter ?? '?'}`);
        lines.push('');

        if (entry.topBefore?.length) {
            lines.push(`### Before â€” Top ${entry.topBefore.length}`);
            lines.push('');
            lines.push('| Rank | Country | Probability |');
            lines.push('|------|---------|-------------|');
            entry.topBefore.forEach((c, i) => lines.push(`| ${i+1} | ${c.name} | ${c.prob}% |`));
            lines.push('');
        }
        if (entry.topAfter?.length) {
            lines.push(`### After â€” Top ${entry.topAfter.length}`);
            lines.push('');
            lines.push('| Rank | Country | Probability | Change |');
            lines.push('|------|---------|-------------|--------|');
            const bMap = {};
            (entry.topBefore || []).forEach(c => bMap[c.name] = c.prob);
            entry.topAfter.forEach((c, i) => {
                const prev = bMap[c.name];
                const d = prev !== undefined ? (c.prob - prev).toFixed(2) : 'new';
                const a = d === 'new' ? 'ğŸ†•' : parseFloat(d) > 0 ? `+${d}% ğŸ“ˆ` : parseFloat(d) < 0 ? `${d}% ğŸ“‰` : 'Â±0%';
                lines.push(`| ${i+1} | ${c.name} | ${c.prob}% | ${a} |`);
            });
            lines.push('');
        }
        lines.push('---');
        lines.push('');
    });

    return lines.join('\n');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REPORT.md GENERATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function generateReportMd() {
    const now = new Date();
    const results = STATE.results;
    const countries = STATE.countries;

    // Group by continent
    const continents = {};
    countries.forEach(c => {
        const cont = c.continent || 'unknown';
        if (!continents[cont]) continents[cont] = { total:0, correct:0, wrong:0, countries:[] };
        const r = results[c.name];
        if (!r || r.status === 'pending') return;
        continents[cont].total++;
        if (r.guessed) continents[cont].correct++;
        else continents[cont].wrong++;
        continents[cont].countries.push({ name: c.name, guessed: r.guessed, q: r.questionsAsked });
    });

    const total  = Object.values(results).filter(r => r.status !== 'pending').length;
    const correct= Object.values(results).filter(r => r.guessed).length;
    const wrong  = total - correct;
    const acc    = total ? ((correct/total)*100).toFixed(1) : '0.0';

    const lines = [];
    lines.push('# GeoAI Bot Test Report');
    lines.push('');
    lines.push(`> Generated: ${now.toISOString()}`);
    lines.push('');
    lines.push('## Overall');
    lines.push('');
    lines.push('| Metric | Value |');
    lines.push('|--------|-------|');
    lines.push(`| Countries Tested | ${total} / ${countries.length} |`);
    lines.push(`| Correct | ${correct} |`);
    lines.push(`| Wrong   | ${wrong} |`);
    lines.push(`| Accuracy | **${acc}%** |`);
    lines.push('');
    lines.push('---');
    lines.push('');
    lines.push('## By Continent');
    lines.push('');

    Object.entries(continents).forEach(([cont, data]) => {
        const meta = CONTINENT_META[cont] || { label: cont, emoji: 'ğŸŒ' };
        const cAcc = data.total ? ((data.correct/data.total)*100).toFixed(1) : '0.0';
        lines.push(`### ${meta.emoji} ${meta.label}`);
        lines.push('');
        lines.push(`**${cAcc}%** accuracy â€” ${data.correct} / ${data.total} correct`);
        lines.push('');
        lines.push('| Country | Result | Questions | Debug |');
        lines.push('|---------|--------|-----------|-------|');
        data.countries.forEach(c => {
            const icon = c.guessed ? 'âœ…' : 'âŒ';
            const link = `[view](Debug/Countries/${encodeURIComponent(c.name)}.md)`;
            lines.push(`| ${c.name} | ${icon} | ${c.q} | ${link} |`);
        });
        lines.push('');
    });

    lines.push('---');
    lines.push('');
    lines.push('## Countries Guessed Correctly');
    lines.push('');
    const correctList = Object.entries(results).filter(([,r])=>r.guessed).map(([n])=>n).sort();
    lines.push(correctList.map(n => `- ${n}`).join('\n') || '_None_');
    lines.push('');
    lines.push('## Countries Not Guessed');
    lines.push('');
    const wrongList = Object.entries(results).filter(([,r])=>r.status!=='pending'&&!r.guessed).map(([n])=>n).sort();
    lines.push(wrongList.map(n => `- ${n}`).join('\n') || '_None_');

    return lines.join('\n');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RUN ORCHESTRATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function startRun() {
    if (STATE.running) return;

    if (!STATE.config.backendUrl) {
        toast('Set Backend URL in Config first', 'warn');
        toggleSettings();
        return;
    }

    // Load data if not already
    if (!STATE.countries.length) {
        const ok = await loadData();
        if (!ok) return;
    }

    // Health check
    const healthy = await checkHealth();
    if (!healthy) {
        toast('Backend is offline. Cannot run.', 'err');
        return;
    }

    STATE.running   = true;
    STATE.stopFlag  = false;
    STATE.stat      = { total: STATE.countries.length, ran:0, correct:0, wrong:0 };
    STATE.results   = {};
    STATE.runStartTime = Date.now();

    // Init results
    STATE.countries.forEach(c => {
        STATE.results[c.name] = { status:'pending', guessed:false, questionsAsked:0, mdContent:'' };
    });

    // Render initial grid
    renderGrid();
    updateStats();

    document.getElementById('runBtn').disabled = true;
    document.getElementById('runBtn').classList.add('btn-start-running');
    document.getElementById('stopBtn').style.display = '';
    document.getElementById('pushBtn').disabled = true;
    document.getElementById('reportSection').style.display = 'none';

    log(`Starting run for ${STATE.countries.length} countries...`, 'info');

    // Run sequentially (backend may not support high concurrency on free tier)
    for (let i = 0; i < STATE.countries.length; i++) {
        if (STATE.stopFlag) { log('Run stopped by user.', 'warn'); break; }

        const country = STATE.countries[i];
        setCountryStatus(country.name, 'running');
        log(`[${i+1}/${STATE.countries.length}] Testing: ${country.name}`, 'info');

        try {
            const result = await playGame(country);
            STATE.results[country.name] = {
                status: result.guessed ? 'correct' : 'wrong',
                guessed: result.guessed,
                questionsAsked: result.questionsAsked,
                confidence: result.confidence,
                mdContent: result.mdContent
            };
            STATE.stat.ran++;
            if (result.guessed) STATE.stat.correct++;
            else STATE.stat.wrong++;

            setCountryStatus(country.name, result.guessed ? 'correct' : 'wrong', result.questionsAsked);
            log(
                `  â†’ ${result.guessed ? 'âœ…' : 'âŒ'} ${result.guessed ? 'CORRECT' : 'WRONG'} â€” guessed "${result.prediction}" in ${result.questionsAsked}q`,
                result.guessed ? 'ok' : 'err'
            );
        } catch(e) {
            if (e.message === 'STOPPED') { setCountryStatus(country.name, 'pending'); break; }
            STATE.results[country.name].status = 'wrong';
            STATE.stat.ran++;
            STATE.stat.wrong++;
            setCountryStatus(country.name, 'wrong');
            log(`  â†’ Error on ${country.name}: ${e.message}`, 'err');
        }

        updateStats();
        updateProgress(i + 1, STATE.countries.length);
    }

    // Finalize
    STATE.running = false;
    document.getElementById('runBtn').disabled = false;
    document.getElementById('runBtn').classList.remove('btn-start-running');
    document.getElementById('stopBtn').style.display = 'none';

    const hasResults = STATE.stat.ran > 0;
    document.getElementById('pushBtn').disabled = !hasResults || !STATE.config.githubToken;

    if (hasResults) {
        const reportMd = generateReportMd();
        document.getElementById('reportMd').textContent = reportMd;
        document.getElementById('reportSection').style.display = '';
        document.getElementById('reportBox').classList.add('open');
        const acc = ((STATE.stat.correct / STATE.stat.ran) * 100).toFixed(1);
        log(`Run complete. Accuracy: ${acc}% (${STATE.stat.correct}/${STATE.stat.ran})`, 'ok');
        toast(`Done! ${acc}% accuracy (${STATE.stat.correct}/${STATE.stat.ran})`, 'ok');
    }
}

function stopRun() {
    STATE.stopFlag = true;
    STATE.running  = false;
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('runBtn').disabled = false;
    document.getElementById('runBtn').classList.remove('btn-start-running');
    log('Stop requested.', 'warn');
    toast('Stopping after current country...', 'warn');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GRID RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderGrid() {
    const grid = document.getElementById('countryGrid');
    grid.innerHTML = '';

    // Group by continent
    const groups = {};
    STATE.countries.forEach(c => {
        const k = c.continent || 'unknown';
        if (!groups[k]) groups[k] = [];
        groups[k].push(c);
    });

    Object.entries(groups).forEach(([cont, countries]) => {
        const meta = CONTINENT_META[cont] || { label: cont, emoji: 'ğŸŒ' };
        const section = document.createElement('div');
        section.className = 'continent-section open';
        section.dataset.continent = cont;

        section.innerHTML = `
            <div class="continent-header" onclick="toggleContinent(this)">
                <span class="continent-emoji">${meta.emoji}</span>
                <span class="continent-name">${meta.label}</span>
                <div class="continent-progress-wrap">
                    <div class="continent-progress-fill" data-cont="${cont}" style="width:0%"></div>
                </div>
                <span class="continent-counts" data-cont-counts="${cont}">0 / ${countries.length}</span>
                <i class="fa-solid fa-chevron-down continent-chevron"></i>
            </div>
            <div class="continent-body" id="body-${cont}"></div>
        `;

        const body = section.querySelector('.continent-body');
        countries.forEach(c => {
            const card = document.createElement('div');
            card.className = 'country-card status-pending';
            card.id = 'card-' + encodeCardId(c.name);
            card.onclick = () => openDrawer(c.name);
            card.innerHTML = `
                <span class="country-flag">${c.emoji || 'ğŸ³'}</span>
                <div class="country-info">
                    <div class="country-name">${c.name}</div>
                    <div class="country-meta">${c.region || ''} ${c.subRegion ? 'Â· '+c.subRegion : ''}</div>
                </div>
                <span class="country-status-icon pending" id="icon-${encodeCardId(c.name)}">
                    <i class="fa-regular fa-clock"></i>
                </span>
            `;
            body.appendChild(card);
        });

        grid.appendChild(section);
    });
}

function encodeCardId(name) {
    return name.replace(/[^a-zA-Z0-9]/g, '_');
}

function toggleContinent(header) {
    header.closest('.continent-section').classList.toggle('open');
}

function setCountryStatus(name, status, questionsAsked) {
    const id = encodeCardId(name);
    const card = document.getElementById('card-' + id);
    const icon = document.getElementById('icon-' + id);
    if (!card || !icon) return;

    card.className = `country-card status-${status}`;

    const iconMap = {
        pending: '<i class="fa-regular fa-clock"></i>',
        running: '<i class="fa-solid fa-spinner"></i>',
        correct: '<i class="fa-solid fa-circle-check"></i>',
        wrong:   '<i class="fa-solid fa-circle-xmark"></i>'
    };
    icon.className = `country-status-icon ${status}`;
    icon.innerHTML = iconMap[status] || '';

    if (questionsAsked !== undefined) {
        const meta = card.querySelector('.country-meta');
        if (meta) {
            const country = STATE.countries.find(c => c.name === name);
            const base = country ? `${country.region || ''}${country.subRegion ? ' Â· '+country.subRegion : ''}` : '';
            meta.textContent = base + (questionsAsked ? ` Â· ${questionsAsked}q` : '');
        }
    }

    // Update continent progress
    const cont = STATE.countries.find(c => c.name === name)?.continent;
    if (cont) updateContinentProgress(cont);
}

function updateContinentProgress(cont) {
    const countries = STATE.countries.filter(c => c.continent === cont);
    const done = countries.filter(c => {
        const r = STATE.results[c.name];
        return r && r.status !== 'pending';
    }).length;
    const fill = document.querySelector(`.continent-progress-fill[data-cont="${cont}"]`);
    const counts = document.querySelector(`[data-cont-counts="${cont}"]`);
    if (fill) fill.style.width = (done / countries.length * 100) + '%';
    if (counts) counts.textContent = `${done} / ${countries.length}`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS & PROGRESS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateStats() {
    const s = STATE.stat;
    document.getElementById('statRan').textContent     = s.ran;
    document.getElementById('statCorrect').textContent = s.correct;
    document.getElementById('statWrong').textContent   = s.wrong;
    document.getElementById('statAcc').textContent     = s.ran
        ? ((s.correct / s.ran) * 100).toFixed(1) + '%' : 'â€”';
}
function updateProgress(done, total) {
    const pct = Math.round(done / total * 100);
    document.getElementById('overallProgressFill').style.width = pct + '%';
    document.getElementById('progressMeta').textContent = `${done} / ${total} (${pct}%)`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COUNTRY DETAIL DRAWER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openDrawer(name) {
    const country = STATE.countries.find(c => c.name === name);
    if (!country) return;
    STATE.currentDrawer = name;

    document.getElementById('drawerFlag').textContent = country.emoji || 'ğŸ³';
    document.getElementById('drawerName').textContent = country.name;
    document.getElementById('drawerSub').textContent  =
        [country.continent, country.region, country.subRegion].filter(Boolean).join(' Â· ');

    const r = STATE.results[name];
    const banner = document.getElementById('drawerBanner');
    const bannerText = document.getElementById('drawerBannerText');
    const dlBtn = document.getElementById('drawerDownloadBtn');

    if (!r || r.status === 'pending') {
        banner.className = 'drawer-result-banner pending';
        banner.querySelector('i').className = 'fa-solid fa-clock';
        bannerText.textContent = 'Not run yet';
        document.getElementById('drawerContent').innerHTML = `
            <div class="drawer-placeholder">
                <i class="fa-solid fa-file-code"></i>
                <p>Run this country to see its debug report</p>
            </div>`;
        dlBtn.style.display = 'none';
    } else {
        if (r.guessed) {
            banner.className = 'drawer-result-banner correct';
            banner.querySelector('i').className = 'fa-solid fa-circle-check';
            bannerText.textContent = `Correctly guessed in ${r.questionsAsked} questions (${r.confidence}% confidence)`;
        } else {
            banner.className = 'drawer-result-banner wrong';
            banner.querySelector('i').className = 'fa-solid fa-circle-xmark';
            bannerText.textContent = `Wrong â€” asked ${r.questionsAsked} questions (${r.confidence}% confidence)`;
        }
        document.getElementById('drawerContent').innerHTML =
            `<pre class="drawer-md">${escHtml(r.mdContent)}</pre>`;
        dlBtn.style.display = '';
    }

    document.getElementById('drawerOverlay').classList.add('open');
    document.getElementById('detailDrawer').classList.add('open');
}

function closeDrawer() {
    document.getElementById('drawerOverlay').classList.remove('open');
    document.getElementById('detailDrawer').classList.remove('open');
    STATE.currentDrawer = null;
}

function downloadCountryReport() {
    const name = STATE.currentDrawer;
    if (!name) return;
    const r = STATE.results[name];
    if (!r?.mdContent) return;
    downloadBlob(r.mdContent, `${name}.md`, 'text/markdown');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REPORT BOX TOGGLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleReportBox() {
    document.getElementById('reportBox').classList.toggle('open');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOWNLOAD REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function downloadReport() {
    const md = document.getElementById('reportMd').textContent;
    if (!md) return;
    downloadBlob(md, 'REPORT.md', 'text/markdown');
}
function downloadBlob(content, filename, mime) {
    const blob = new Blob([content], { type: mime });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url; a.download = filename;
    document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GITHUB PUSH
   Uses GitHub Contents API (no server needed)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function pushResults() {
    if (!STATE.config.githubToken) {
        toast('GitHub token not set. Configure it first.', 'warn');
        toggleSettings();
        return;
    }

    const ran = Object.entries(STATE.results).filter(([,r]) => r.status !== 'pending');
    if (!ran.length) { toast('No results to push', 'warn'); return; }

    document.getElementById('pushBtn').disabled = true;
    toast('Pushing to GitHubâ€¦', 'info');
    log('Starting GitHub push...', 'info');

    const { githubOwner, githubRepo, githubBranch, githubToken } = STATE.config;
    const base = `https://api.github.com/repos/${githubOwner}/${githubRepo}/contents/`;
    const headers = {
        'Authorization': `Bearer ${githubToken}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json',
        'X-GitHub-Api-Version': '2022-11-28'
    };

    let pushed = 0, failed = 0;

    // Push each country debug MD
    for (const [name, r] of ran) {
        if (!r.mdContent) continue;
        const path = `Debug/Countries/${name}.md`;
        try {
            await githubPutFile(base, path, r.mdContent, githubBranch, headers, `bot: debug report for ${name}`);
            pushed++;
            if (pushed % 10 === 0) log(`  Pushed ${pushed} filesâ€¦`, 'info');
        } catch(e) {
            failed++;
            log(`  Failed to push ${name}: ${e.message}`, 'err');
        }
    }

    // Push REPORT.md
    const reportMd = generateReportMd();
    try {
        await githubPutFile(base, 'Debug/REPORT.md', reportMd, githubBranch, headers, 'bot: update accuracy report');
        log('Pushed Debug/REPORT.md', 'ok');
    } catch(e) {
        log('Failed to push REPORT.md: ' + e.message, 'err');
        failed++;
    }

    document.getElementById('pushBtn').disabled = false;
    const acc = STATE.stat.ran ? ((STATE.stat.correct/STATE.stat.ran)*100).toFixed(1) : '0';
    log(`Push done. ${pushed} files pushed, ${failed} failed.`, failed ? 'warn' : 'ok');
    toast(`Pushed ${pushed} files to GitHub (${failed} failed)`, failed ? 'warn' : 'ok');
}

async function githubPutFile(base, path, content, branch, headers, message) {
    // Check if file exists to get its SHA (required for update)
    let sha = null;
    try {
        const r = await fetch(base + encodeURIComponent(path) + `?ref=${branch}`, { headers });
        if (r.ok) {
            const d = await r.json();
            sha = d.sha;
        }
    } catch(_) {}

    const body = {
        message,
        content: btoa(unescape(encodeURIComponent(content))),
        branch
    };
    if (sha) body.sha = sha;

    const res = await fetch(base + encodeURIComponent(path), {
        method: 'PUT', headers, body: JSON.stringify(body)
    });
    if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.message || `HTTP ${res.status}`);
    }
    return res.json();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API HELPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function apiCall(endpoint, method, data) {
    const url = STATE.config.backendUrl + endpoint;
    const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: data ? JSON.stringify(data) : undefined,
        signal: AbortSignal.timeout(30000)
    });
    if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error || `HTTP ${res.status}`);
    }
    return res.json();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI UTILITIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function log(msg, type = '') {
    const box = document.getElementById('logBox');
    const p = document.createElement('p');
    const ts = new Date().toTimeString().slice(0,8);
    p.className = type ? `log-${type}` : '';
    p.innerHTML = `<span class="log-ts">[${ts}]</span> ${escHtml(msg)}`;
    box.appendChild(p);
    box.scrollTop = box.scrollHeight;
}
function clearLog() {
    document.getElementById('logBox').innerHTML = '';
    log('Log cleared.', 'info');
}
function toast(msg, type = '') {
    const c = document.getElementById('toast-container');
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = msg;
    c.appendChild(t);
    setTimeout(() => t.remove(), 4000);
}
function escHtml(str) {
    return String(str)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded', () => {
    updateConfigPills();
    log('Bot Runner v1.1.1 ready.', 'info');
    log('Click Config (top right) to set Backend URL and GitHub Token.', 'info');
});
</script>
</body>
</html>
